---
title: "Stranding project"
author: "Ellen Coombs"
date: "04/12/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Markdown for stranding project 

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

This is the R markdown document 

## Data cleaning and binding 

1. Cleaning and standardising the Natural History Museum (NHM), Cetacean Stranding Investigation Programme (CSIP) and Irish Whale and Dolphin Group (IWDG) datasets for binding 
2. Binding the 3 datasets (NHM + CSIP first, followed by IWDG which was aquired at a later date)

## Temporal and spatial analysis and plotting 

1. Figure 1: Stranding events of cetacean species in UK and Irish waters from 1913-2015. The y axis shows the species found in the UK and Irish stranding records. 
2. Figure 2: Temporal and spatial variation in cetacean strandings records for all species, odontocetes (toothed whales), and mysticetes (baleen whales) in the waters around the UK and Ireland from 1913-2015. 

## Model creation 

1. Data collection for Generalised Additive Models (GAMs)
i. Sea Surface Temperature (SST) - ncdf file and maximum values 
ii. Geomagnetic data 
iii. North Atlantic Oscillation 
iv. Storms 
v. Population 
vi. Total strandings 

2. Creation of data table for model - bind 

## Generalised Additive Models 

1. Running GAMs for All_strandc (all records) and No_phocoena 
2. GAM code 


## Data cleaning and binding 
### This code cleans and binds the NHM and CSIP datasets 
```{r, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)


#Code for cleaning up messy dates in the NHM dataset 
#Code for standardising dates in the CSIP dataset 
#Code for renaming columns so that both datsets have the same variables 
#Code for binding the two datasets together 

#Load libraries/packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)

#read in raw data 
nhm <- read.csv("EDITNHMdata.csv")
#read in raw data 
csip <- read.csv("EDITCSIPdata.csv")
names(csip)
names(nhm)

#What class is everything? (important when binding)
sapply(csip, class)
sapply(nhm, class)

str(nhm)#returns the structure of the dataset
str(csip)

#Cleaning column names to keep and rename where necessary:
#Name Common
#Name Current Sci
#Date (NHM) Date found (CSIP)
#Location
#Grid ref
#County (NHM) Local authority (CSIP); change to county

#Check all names are the same for binding
#Code for renaming if not 
names(csip)
names(nhm)
csip <- dplyr::rename(csip, County = Local.Authority)
csip <- dplyr::rename(csip, Name.Common = Name.common) 
#nhm <- rename(nhm, Grid.Ref = "Grid ref")
nhm <-dplyr::rename(nhm, Year = year)
csip <- dplyr::rename(csip, Year = year)
csip <- dplyr::rename(csip, S.W.No. = National.Reference)
#nhm <- rename(nhm, Name.Current.Sci = "Name Current Sci")
#nhm <- rename(nhm, Name.Common = "Name Common")
#csip <- rename(csip, Name.Current.Sci = "Name Current Sci")


#Changing dates and names in the selectnhm
csip$Date #all dates appear in the same format...
nhm$Date #some dates appear as August 1929 or Summer 1929, code below to clean


#attempt using mutate to change "beg" "mid" "end" and "Summer" "Winter" etc
#Beg and early = 1
#Mid = 14
#End = 27
#wk 1 = 1
#wk 2 = 8
#wk 3 = 15
#wk 4 = 22
#Spring = 20 Mar
#Summer = 21 Jun
#Autumn = 22 Sep
#Winter = 21 Dec

#16-17 range of dates to take earliest date
#what shall I do with 4-5 etc, ?, 'c' and mm yyyy? How? Also Jun 1929 etc



#embedding commands
nhm$Date <- gsub("Summer", "1 Jun",
            gsub("Winter", "1 Dec",
            gsub("Spring", "1 Mar",
            gsub("Autumn", "1 Sept",
            gsub("beg", "1",
            gsub("Beg", "1",
            gsub("mid", "14",
            gsub("Mid", "14",
            gsub("end", "27",
            gsub("End", "27",
            gsub("Early", "1",
            gsub("Ely", "1",
            gsub("Early", "1",
            gsub("wk1", "1",
            gsub("wk2", "8",
            gsub("wk3", "15",
            gsub("wk4", "22",
            gsub("Wk4", "22",
                 nhm$Date))))))))))))))))))


#more specific changes - might have to do each at a time?

#checking if the above has worked
nhm$Date
head(nhm$Date)
tail(nhm$Date)


#Select specific coloumns
selectnhm <- select(nhm, S.W.No., Name.Current.Sci, Name.Common, Latitude, Longitude, County, Date, Year)
selectcsip <- select(csip, S.W.No., Name.Current.Sci, Name.Common, Latitude, Longitude, County, Date, Year)

#Checking that the above has worked 
selectnhm$Date


#Changing date format in the NHM dataset
library(lubridate)
library(dplyr)
#Why is this adding 100 years???
selectnhm <- mutate(selectnhm, Date = dmy(Date))

#Trying this instead - works by changing all 2000s to 1900s
nhmdates <- select(nhm, Date)
selectnhm <- mutate(nhmdates, Date = format(as.Date(Date, "%d-%b-%y"), "19%y-%m-%d"))
selectnhm

#Changing selectnhm to a 'Date' rather than a 'character'
selectnhm <- mutate(selectnhm, Date = as.Date(Date)) 

sapply(selectnhm, class)

#Double checking
View(selectnhm)

#Adding the mutated date column 
#Changing the Latitudes to 'numeric' 
nhmnew <- select(nhm, S.W.No., Name.Current.Sci, Name.Common, Latitude, Longitude, County, Year)
#nhmnew <- mutate(nhmnew, Latitude = as.numeric(Latitude))
nhmfinal <- bind_cols(nhmnew, selectnhm, .id = NULL)
nhmfinal$Date

nhmfinal


#Changing CSIP date to YYYYMMMDD
csip$Date
csip <- mutate(csip, Date = dmy(Date))

#Selecting all of the variables 
csipfinal <- select(csip, S.W.No., Name.Current.Sci, Name.Common, Latitude, Longitude, County, Date, Year)
csipfinal


#merging the two datasets
#Checking that both have the same classes

sapply(nhmfinal, class)
sapply(csipfinal, class)

#CSIP Longitude is a factor for some reason 
csipfinal$Longitude <- as.numeric(csipfinal$Longitude)

#Merging the two datasets 
nhmcsip <- bind_rows(nhmfinal, csipfinal)
View(nhmcsip)

#Saving the new dataset 
write.csv(nhmcsip, file = "cleandatesnames.csv") 

```

### This code cleans the IWDG data and binds it to the NHM and CSIP ("cleandatesnames")

```{r, echo= TRUE}

#Irish data 
#Cleaning dataes and names to be the same as the "cleandatesnames")
#Removing duplicates that appear in both the NHM and IWDG datasets 

library(dplyr)
library(lubridate)
#First of all the cleaned NHM/CSIP data 
cleaneddata <- read.csv("cleandatesnames.csv")

#Check species names
levels(cleaneddata$Name.Current.Sci)

Irish_data <- read.csv("Irish_strandings_raw.csv")
Irish_data$X. <- NULL

#Rename columns so that I can bind the datasets
Irish_data <- Irish_data %>%
  dplyr::rename(Date = Event.Date)

#Remove non cetaceans 
Irish_data <- Irish_data %>% 
  filter(!(Species %in% c("leatherback turtle", "basking shark", "loggerhead turtle", "Kemp's ridley turtle")))

#Double check we just have cetaceans 
levels(Irish_data$Species)

#Unknowns 
#These are listed as "whale species" in the Irish data 
#Changing to the same names as the NHM/CSIP
Irish_data$Species<-as.character(Irish_data$Species)
Irish_data$Species[Irish_data$Species %in% "cetacean species"] <- "Unknown" 
Irish_data$Species[Irish_data$Species %in% "whale species"] <- "Unknown" 
Irish_data$Species[Irish_data$Species %in% "large whale species"] <- "Unknown" 
Irish_data$Species[Irish_data$Species %in% "lagenorhynchus species"] <- "Unknown delphinid" 
Irish_data$Species[Irish_data$Species %in% "common or striped dolphin"] <- "Unknown delphinid" 
Irish_data$Species[Irish_data$Species %in% "dolphin species"] <- "Unknown delphinid" 
Irish_data$Species[Irish_data$Species %in% "pilot/false killer whale"] <- "Unknown odontocete" 
Irish_data$Species[Irish_data$Species %in%  "dolphin species possibly harbour porpoise"] <- "Unknown"
Irish_data$Species[Irish_data$Species %in%  "sei fin or blue whale"] <- "Unknown mysticete" 
Irish_data$Species[Irish_data$Species %in%  "beaked whale species"] <- "Unknown odontocete"

#Filter out the years (1913:2015)
Irish_data <- Irish_data %>%
  filter(Year %in% c(1913:2015))

#Cleaning Scientific names 
Irish_data$Name.Current.Sci<-as.character(Irish_data$Name.Current.Sci)
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "cetacean species"] <- "Unknown" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "whale species"] <- "Unknown" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "large whale species"] <- "Unknown" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "lagenorhynchus species"] <- "Unknown delphinid" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "common or striped dolphin"] <- "Unknown delphinid" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "dolphin species"] <- "Unknown delphinid" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in% "pilot/false killer whale"] <- "Unknown odontocete" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "dolphin species possibly harbour porpoise"] <- "Unknown"
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "sei fin or blue whale"] <- "Unknown mysticete" 
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "beaked whale species"] <- "Unknown odontocete"
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "dolphin species possibly Phocoena phocoena"] <- "Unknown"
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "common or Stenella coeruleoalba"] <- "Unknown delphinid"
Irish_data$Name.Current.Sci[Irish_data$Name.Current.Sci %in%  "Pseudorca crassidens "] <- "Pseudorca crassidens"


#Need to rename the variables to be the same as NHM/CSIP for binding
Irish_data <- Irish_data %>% 
  dplyr::rename(Name.Common = Species) %>%
  dplyr::rename(County = County.Region) %>%
  dplyr::rename(Latitude = GPS.Lat) %>%
  dplyr::rename(Longitude = GPS.Long) %>%
  dplyr::rename(S.W.No. = Stranding.ID)

#Select out the columns
Irish_data <- Irish_data %>%
  select(Date, Year, Name.Common, Name.Current.Sci, Latitude, Longitude, County, S.W.No.)


#Change date format - same as NHM/CSIP
Irish_data$Date <- Irish_data$Date <- lubridate::dmy(Irish_data$Date)
#As factor to make all data the same 
Irish_data$Name.Common <- as.factor(Irish_data$Name.Common)
Irish_data$Name.Current.Sci <- as.factor(Irish_data$Name.Current.Sci)

#Double check all 
sapply(cleaneddata, class)
sapply(Irish_data, class)

#Cleaneddata Date = factor (may nnot have to run this - but needed to here)
cleaneddata <- mutate(cleaneddata, Date = dmy(Date))

#Bind cleanedata with Irish data 
UK_and_Irish <- bind_rows(cleaneddata, Irish_data)

#Arrange by date 
UK_and_Irish <- UK_and_Irish %>%
  arrange(Date)

arrange(UK_and_Irish, Date)


#Filtering out the EIRE data (these are duplicates) EIRE appears in the NHM data 
#Remove EIRE and Antrim 
#Be aware that Antrim is also written "Antrim N. Ireland" 
#Down = Co.Down 
#Antrim = Co. Antrim 
#Delete all N.I then rename Derry to Co. Derry 
#Londonderry to Co. Derry 
UK_and_Irish <- UK_and_Irish %>% 
  dplyr::filter(UK_and_Irish, !grepl("EIRE", County))

#Remove N.I numbers - this removes most duplicates 
UK_and_Irish <- UK_and_Irish %>% 
  dplyr::filter(!(S.W.No. %in% c("N.I.\\.\\d+")))

UK_and_Irish$County[UK_and_Irish$County %in%  "Down"] <- "Co. Down"
UK_and_Irish$County[UK_and_Irish$County %in%  "Antrim"] <- "Co. Antrim"
UK_and_Irish$County[UK_and_Irish$County %in%  "Londonderry"] <- "Co. Derry"
UK_and_Irish$County[UK_and_Irish$County %in%  "Derry, N.Ireland"] <- "Co. Derry"
UK_and_Irish$County[UK_and_Irish$County %in%  "Down, N.Ireland"] <- "Co. Down"
UK_and_Irish$County[UK_and_Irish$County %in%  "Antrim, N.Ireland"] <- "Co. Antrim"
UK_and_Irish$County[UK_and_Irish$County %in%  "Londonderry"] <- "Co. Derry"
UK_and_Irish$County[UK_and_Irish$County %in%  "Co.Derry, N.Ireland"] <- "Co. Derry"
UK_and_Irish$County[UK_and_Irish$County %in%  "Donegal"] <- "Co. Donegal"
UK_and_Irish$County[UK_and_Irish$County %in%  "Cork"] <- "Co. Cork"

UK_and_Irish$Name.Current.Sci<-as.character(UK_and_Irish$Name.Current.Sci) 
UK_and_Irish$Name.Current.Sci[UK_and_Irish$Name.Current.Sci %in%  "Orcinus orca "] <- "Orcinus orca"
UK_and_Irish$Name.Current.Sci[UK_and_Irish$Name.Current.Sci %in%  "Physeter macrocephalus "] <- "Physeter macrocephalus"
UK_and_Irish$Name.Current.Sci[UK_and_Irish$Name.Current.Sci %in%  "Pseudorca crassidens "] <- "Pseudorca crassidens"


#for duplicates by date, name and county 
UK_and_Irish <- UK_and_Irish[!(duplicated(UK_and_Irish[c("Date","Name.Current.Sci", "County")]) | duplicated(UK_and_Irish[c("Date","Name.Current.Sci", "County")], fromLast = TRUE)), ]


write.csv(UK_and_Irish, file = "UK_and_Irish_strandings.csv")

#Quick plot of Data, including Irish counts 
UK_and_Irish <- read.csv("UK_and_Irish_strandings.csv")

#Species per year 
#Strandings_IRL_UK <- UK_and_Irish %>%
  #select(Name.Current.Sci, Year)

#A count per year of each species (with unknowns) - if required 
Strandings_count_IRL_UK <- count(Strandings_IRL_UK, Year, Name.Current.Sci)

#Plotting the above if required 
ggplot(data = Strandings_count_IRL_UK, aes(x = Year, y = n, colour= Name.Current.Sci))+
  theme(panel.background = element_blank(), panel.border = element_rect(colour = "grey40", fill = NA)) +
  labs(x = "Year", y = "Count") +
  geom_line() +
  theme_bw() + 
  theme(legend.position="bottom") +
  scale_fill_manual(values=c("deeppink", "steelblue"), guide=FALSE) + 
  facet_wrap(~ Species)   


```

### Removing unknown and rare species from the final NHM, CSIP, IWDG combined dataset 
#### Creation of final dataset for analysis 
```{r, echo=TRUE}
UK_and_Irish <- read.csv("UK_and_Irish_strandings.csv")

UK_and_Irish_known <- UK_and_Irish %>%
  filter(!(Name.Current.Sci %in% c("Unknown", "Unknown odontocete", "Unknown odontocete ",
                                   "Unknown delphinid ",
                                   "Unknown delphinid", "Unknown delphinid ", 
                                   "Unknown mysticete")))

#Removing rare species - this is now the final dataset for analysis 
UK_and_Irish_sp <- UK_and_Irish_known %>%
  filter(!(Name.Current.Sci %in% c("Monodon monoceros", "Peponocephala electra", 
                                   "Delphinapterus leucas", "Kogia sima",
                                   "Mesoplodon densirostris", "Mesoplodon europaeus",
                                   "Lagenodelphis hosei")))

#This is the final cleaned dataset with unknowns removed and rare species removed
write.csv(UK_and_Irish_sp, file = "UK_and_Irish_sp.csv")

```

## Temporal and spatial analysis and plotting - Figure 1 
### Code for plotting temporal plot 
```{r, echo=TRUE}

#Make Figure 1 - plot of individual species stranding through time 

library(plyr)
library(ggplot2)
library(viridis)

# load all the strandings data
alls <- read.csv("all_strandings.csv")


# chance Total_strandings to Total_events to get # events
plotdat <- ddply(alls, .(Year, Species), summarize, total=sum(Total_strandings))

# remove the zeros so they are transparent in plot
plotdat <- plotdat[plotdat$total != 0,]
# reverse sp. order alphabetically
plotdat$Species <- factor(plotdat$Species, levels = rev(levels(plotdat$Species)))

#what should the upper limit be?
#> max(plotdat$total)
#[1] 501

#build the plot
p <- ggplot(plotdat) +
  geom_tile(aes(x=Year, y=Species, fill=total)) +
  scale_x_continuous(expand=c(0,0)) +
  theme_minimal() +
  labs(fill="Individuals", y="") +
  #needs to be on the log scale because of pho^2 :(
  scale_fill_viridis(trans = "log", na.value="white",
                     #501 was from the above commented 'max' code 
                     limits = c(1, 501),
                     breaks = c(1, 10, 20, 50, 100, 250, 500),
                     labels = c(1, 10, 20, 50, 100, 250, 500)) +
  theme(legend.position="bottom", legend.key.width=unit(0.1, "npc"),
        #This makes the text italic 
        axis.text.y=element_text(face="italic")) +
  #Need to bold the balaenopterids 
  theme(axis.text.y=element_text(face=ifelse(levels(plotdat$Species)=="Balaenoptera acutorostrata","bold","italic")))


print(p)
#Save plot 
ggsave(p, filename="measles.pdf", width=10, height=6)

```

### Code for plotting temporal plot (Figure 2) with key events and decadal spatial plots 
#### This code is needed to make the dataset to plot Figure 2. 
```{r, echo=TRUE}

library(maps)
library(mapdata)
library(dplyr)

#Reading in cleaned data with unknowns removed and rare species removed 
#cleaneddata <- read.csv("UK_and_Irish_strandings.csv")
cleaneddata <- read.csv("UK_and_Irish_sp.csv")

latlong <- select(cleaneddata, Year, Name.Current.Sci, Longitude, Latitude)
bphysalus <- filter(latlong, Name.Current.Sci ==  "Balaenoptera physalus")
bactorostrata <- filter(latlong, Name.Current.Sci ==  "Balaenoptera acutorostrata")
bborealis <- filter(latlong, Name.Current.Sci ==  "Balaenoptera borealis")
bmusculus <- filter(latlong, Name.Current.Sci ==  "Balaenoptera musculus")
#unmysticete <- filter(latlong, Name.Current.Sci ==  "Unknown mysticete")
#unbalaenopterid <- filter(latlong, Name.Current.Sci ==  "Unknown balaenoptera")
#mysticete <- filter(latlong, Name.Current.Sci == "Un. mystitcete")
mnovaeangliae <- filter(latlong, Name.Current.Sci == "Megaptera novaeangliae")

#bind all mysticetes
combinedmysticetes <- rbind(bphysalus, bactorostrata, bborealis, bmusculus, mnovaeangliae)

#Stripping out odontocetes 
odontocetes <- latlong[ !(latlong$Name.Current.Sci %in% sortedmysticetes$Name.Current.Sci), ]

#Ordering and combining species by year - to arrange in descending order put "desc" before the year 
sortedodonts <- arrange(odontocetes,(Year))

sortedmysticetes$whatareyou <- "mysticete"
sortedodonts$whatareyou <- "odontocete"


# Natalie hates beaked whales
#beakers <- latlong %>% 
#  filter(Name.Current.Sci %in% c("Hyperoodon ampullatus", "Mesoplodon densirostris", "Mesoplodon europaeus", "Mesoplodon mirus"))
#
#beakers$whatareyou <- "beaker"


allall <- rbind(sortedodonts, sortedmysticetes)
allall$whatareyou <- "all"
allparv <- rbind(sortedodonts, sortedmysticetes, allall)


save(allparv, file="allparv.RData")
 

```


### Plotting Figure 2 
```{r, echo=TRUE}

#Here is the code for Figure 2 
#Ellen - have changed the code for a slightly different dataset!

library(ggplot2)
library(viridis)
library(dplyr)
library(maps)
library(hexbin)
library(ggmap)
library(gridExtra)
library(tidyverse)

#Extract UK map
#Added Ireland
uk <- map_data("world", regions = c('UK', 'Ireland', 'Guernsey', 'Jersey', 'Isle of Man'))

#Create base map
gg1 <-
  ggplot() +
  geom_polygon(data = uk, aes(x = long, y = lat, group = group),
               fill = "white", color = "grey70") +
  coord_fixed(1.3)

#Read in the strandings data
#This is the cleaned data with unknowns and rare species removed
ds <- read.csv("UK_and_Irish_sp.csv")

#This dataset comes from "make_megadata.R"
load("allparv.RData")

ds <- allparv

# capitalize the labels
ds$whatareyou <- Hmisc::capitalize(ds$whatareyou)


#function to build the hexmaps
make_data <- function(ds, years, labs=FALSE){
  # Remove NAs from coordinates
  # And restrict to things in UK waters
  #Filter species here too·
  ds <- ds %>%
    filter(!is.na(Latitude) & !is.na(Longitude)) %>%
    filter(Latitude < 62 & Latitude > 45) %>%
    filter(Longitude < 3 & Latitude > -11)


  ds <- ds %>%
    filter(Year>=years[1] & Year<years[2])

  #Basic plot using viridis colour scheme
  #Note that you can change bins and transparency
  
  pp <- gg1+
    geom_hex(data = ds, aes(y = Latitude, x= Longitude), bins = 50, alpha = 0.75) +
    theme_minimal() +
    facet_wrap(~whatareyou, ncol=1, strip.position="left") +
    labs(x="", y="") +
    scale_fill_viridis(trans = "log", na.value="white",
                       limits = c(1, 501),
                       breaks = c(1, 10, 20, 50, 100, 250, 500),
                       labels = c(1, 10, 20, 50, 100, 250, 500)) +
    ggtitle(paste0(years[1], "-", years[2]))
  if(labs){
    pp <- pp +
      theme(legend.position= c(10.1,1.35),
            axis.text=element_blank(),
            strip.text=element_text(),
            plot.title=element_text(hjust=0.5, size=8))
    
    #Adding some legend detail 
    pp <- pp + 
      theme(legend.title = element_text(colour="black", size=10))
    
    pp <- pp + 
      theme(legend.text= element_text(colour="black", size=7))

  
  }else{
    pp <- pp +
      theme(legend.position="none",
            strip.text=element_text(colour="white"),
            axis.text=element_blank(),
            plot.title=element_text(hjust=0.5, size=8))
  }

  return(pp)
}

## make the time series line

# get the data
linesdat <- ds %>%
  group_by(Year, whatareyou) %>%
  summarize(total=n())


# make the timeseries plot
plines <- ggplot(linesdat) +
  scale_x_continuous(labels=seq(1900, 2025, by=25),
                     breaks=seq(1900, 2025, by=25),
                     expand=c(0, 0)) +
  geom_line(aes(x=Year, y=total, group=whatareyou, colour=whatareyou)) +
  #scale_fill_viridis() +
  #Changed variable colours - these are colour blind friendly 
  scale_colour_manual(values=c("#D55E00", "#0072B2", "#73BFB8")) +
  #position = "jitter" + 
  theme_minimal() +
  theme(legend.position= c("right")) +
  labs(x="", y="Total stranded individuals", colour="Suborder") 
  


#Adding events to the plot 
plines <- plines + annotate("rect", xmin=1914, xmax=1918, ymin=0, ymax=800, alpha=.1, fill="gray64") +
  geom_text(
    #where the label starts (on the x axis) and where it finishes (on the y axis)
    #Colour of the label 
    aes(x = 1916, y = 780, label = "WWI"), size = 3, colour = "gray38") + 
  annotate("rect", xmin=1939, xmax=1945, ymin=0, ymax=800, alpha=.1, fill="gray64") +
  geom_text(
    aes(x = 1942, y = 780, label = "WWII"), size = 3, colour = "gray38") + 
  annotate("segment", x =1985, xend=1985, y=50, yend=725, colour = "gray38", size=0.5, arrow=arrow(length=unit(0.1,"cm"))) +
  geom_text(
    aes(x = 1988, y = 780, label = "1985/1986 season:
        Moratorium on whaling comes into effect"), size = 3, colour = "gray38") +
  #Annotation coordinates 
  annotate("segment", x = 1990, xend = 1990, y = 50, yend = 565, colour="gray38", size=0.5, arrow=arrow(length=unit(0.1,"cm"))) + 
  geom_text(
    aes(x = 1995, y = 620, label = "1990: CSIP and IWDG
   programmes start"), size = 3, colour = "gray38") +
  annotate("segment", x = 1945, xend = 1945, y = 50, yend = 540, colour="gray38", size=0.5, arrow=arrow(length=unit(0.1,"cm"))) + 
  geom_text(
    aes(x = 1945, y = 620, label = "1945: Increase in 
        post-war fishing & 
        whaling effort"), size = 3, colour = "gray38")
  
#put it all together
gr <- grid.arrange(plines,
                   make_data(ds, years=c(1913, 1925), TRUE),
                   make_data(ds, years=c(1926, 1950)),
                   make_data(ds, years=c(1951, 1975)),
                   make_data(ds, years=c(1976, 2000)),
                   make_data(ds, years=c(2001, 2016)),
                   layout_matrix = matrix(c(1,2,1,3,1,4,1,5,1,6), 2, 5))
#Save plot 
ggsave(gr, file="megaplot.pdf", height=13, width=10)

```


## Model creation 
### Data collection for Generalised Additive Models (GAMs)

```{r, echo=TRUE}


#Bringing all the model parameters together to create one dataset for modelling 
#Should all be saved in "modelling" folder 

library(dplyr)
library(tidyr)
library(zoo)

#------------------------------------------------------------------------------------------------
#Storm data 
#Read from "Modelling" folder 
storms <- read.csv("Storm_data.csv")
#Select data 
storms <- storms %>% 
  select(Year, Count)

#Counting up and keeping 0 as 0 
storms <- storms %>% 
  complete(Year, fill = list(Count = 0)) %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(count = sum(Count))

#Renaming count to storms 
Storms <- storms %>%
  rename(Storms = count)

#------------------------------------------------------------------------------------------------
#Population data UK
#Also in the "modelling' folder 
#This is a data file that is combined with yearly strandings 

Population <- read.csv("Population_UK.csv")
Population <- Population %>%
  rename(Year = YEAR) %>%
  rename(Population = POPULATION)

#------------------------------------------------------------------------------------------------
#Geomagnetic max daily, max yearly, max station 

Final_geom <- read.csv("Geom_mean_max.csv")
Final_geom$X <- NULL

#-------------------------------------------------------------------------------------------------
#SST
#Yearly max recorded temperature taken from 14 different places around the UK and Ireland 

SST_yearly_max <- read.csv("SST_yearly_max.csv")
SST_yearly_max <- SST_yearly_max %>% 
  rename(Max_SST = year_max)

#-------------------------------------------------------------------------------------------------
#NAO Data
#From cleaned data 
#Cleaned already 

NAO_data <- read.csv("NAO_data.csv")
NAO_data$X <- NULL




```


###Adding total stranding number to the dataset 
###Binding wth Model_data 

Creation of data table for models
```{r, echo=TRUE}
#'Speciesyearcount' cleaned data: a count of current scientific name and year 
speciesyearcount <- dplyr::count(UK_and_Irish_sp, Name.Current.Sci, Year) %>%
  na.omit()

#This is making sure unknowns aren't factors in the data 
speciesyearcount$Name.Current.Sci <- droplevels(speciesyearcount$Name.Current.Sci)

#Adding a 0 to each year without a record 
speciesyearcount <- speciesyearcount %>% 
  complete(Year = seq(min(1913), max(2015), 1L), Name.Current.Sci = unique(speciesyearcount$Name.Current.Sci))

#NAs -> 0 
speciesyearcount[is.na(speciesyearcount)] <- 0

#join the two datasets
all_strandings <- full_join(speciesyearcount, Model_data, by = "Year")
all_strandings$X <- NULL

#Rename 
all_strandings <- all_strandings %>% 
  rename(Total_strandings = n)

all_strandings <- all_strandings %>%
  rename(Species = Name.Current.Sci)

write.csv(all_strandings, file = "all_strandings.csv")
```


## Generalised Additive Models 
```{r, echo=TRUE}

#Running GAM for all strand 
library(mgcv)
library(broom) #for getting a tidy data output 

#This is to check how high to make the k value (k-1)
#k (almost always k-1)
unique(all_strandings$Max_SST)
unique(all_strandings$Storms)
unique(all_strandings$Max_K_index)

#GAM for the above with Species as the factor smooth
#Family is neg b 
All_strandc <- gam(Total_strandings ~ offset(log(Population)) +s(Year, Species, bs="fs") +
                      s(Storms, k=5, bs="ts") +
                      s(Max_K_index, k=4, bs="ts") +
                      s(Max_SST, bs="ts") +
                      s(NAO_index, bs="ts"), 
                    data= all_strandings, 
                    method = "REML",
                    family=nb())

#GAM summary 
summary(All_strandc)

#Plots of different predictors 
par(mfrow = c(2,2))
plot(All_strandc)

#Gam.check
par(mfrow=c(2,2))
gam.check(All_strandc)


#Tidy gives the neat model output - summarises the model statistical findings 
#e.g. tidy(b_m)
#construct a concise one-row summary of the model. This typically contains values such as R^2, 
#adjusted R^2, and residual standard error that are computed once for the entire model.
#e.g. glance(b_m)

Tidy_All_strand <- list(All_strandc = All_strandc) 

#Saving the tidy and glance datasets 
All_strand_tidy <- plyr::ldply(Tidy_All_strand, tidy, .id = "model")
All_strand_glance <- plyr::ldply(Tidy_All_strand, glance, .id = "model")

#Save to csv if required 
write.csv(All_strand_tidy, file = "All_tidy1567.csv")
write.csv(All_strand_glance, file = "All_glance1567.csv")


#This next chunk of code looks at point specifics to determine outliers (in this case
#it led to removing harbour porpoises) 

#Having a look at the response plot (strandings)
par(mfrow=c(1,1))
fitted_A <- fitted(All_strandc)
response_A <-  All_strandc$y
plot(fitted_A[response_A<50], response_A[response_A<50], pch=19, cex=0.2, asp=1)
abline(a=0,b=1)

#Using identify
identify(fitted_A[response_A<50], response_A[response_A<50])

#Pick out any remaining outliers if needed: 
#Example: all_strandings[response_A<50,][1894,]#Phocoena phocoena 

#Highlighting phocoena as possible outliers (can do this with any species)
plot(fitted_A, response_A, pch=19, cex=0.2, asp=1)
points(fitted_A[all_strandings$Species=="Phocoena phocoena"], 
      response_A[all_strandings$Species=="Phocoena phocoena"], pch=19, cex=0.5, col="red")
abline(a=0,b=1)

```



###Running GAMs for data with Phocoena phocoena (Harbour porpoise) removed 
```{r, echo=TRUE}

#Removing Harbour porpoise from the dataset 
No_phocoena <- all_strandings %>%
  filter(Species != "Phocoena phocoena")

No_phocoena_c1 <- gam(Total_strandings ~ offset(log(Population)) +s(Year, Species, bs="fs") +
                     s(Storms, k=5, bs="ts") +
                     s(Max_K_index, k=4, bs="ts") +
                     s(Max_SST, bs="ts") +
                     s(NAO_index, bs="ts"), 
                   data= No_phocoena, 
                   method= "REML",
                   family=nb())

#Summary and predictor plots 
summary(No_phocoena_c1)
par(mfrow = c(2,2))
plot(No_phocoena_c1)

#Gam.check 
par(mfrow=c(2,2))
gam.check(No_phocoena_c1)


#Plot with no Phocoena 
par(mfrow=c(1,1))
fitted_A <- fitted(No_phocoena_c1)
response_A <-  No_phocoena_c1$y
plot(fitted_A[response_A<200], response_A[response_A<200], pch=19, cex=0.2, asp=1)
abline(a=0,b=1)


#Using broom to tidy 

#Tidy multiple models at once 
Tidy_no_phocoena <- list(No_phocoena1 = No_phocoena1)

#Tidy and glance datasets 
No_phocoena_tidy <- plyr::ldply(Tidy_no_phocoena, tidy, .id = "model")
No_phocoena_glance <- plyr::ldply(Tidy_no_phocoena, glance, .id = "model")

#Save to csv
#write.csv(No_phocoena_tidy, file = "No_phocoena_tidy.csv")
#write.csv(No_phocoena_glance, file = "No_phocoena_glance.csv")

```


### Creation of data table for model - bind 
```{r, echo=TRUE}

```



```{r, echo=TRUE}

#Plot all species stranding - facet_wrap 
#Using all_strandings 

ggplot() + 
  geom_line(data = all_strandings, aes(x = Year, y = Total_strandings, colour = Species)) + 
  theme_bw() +
  facet_wrap(~ Species, scales = "free")

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
