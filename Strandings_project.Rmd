---



Currently not knitting, but I will have this sorted! 


title: "Strandings project"
author: "Ellen Coombs"
date: "24 July 2017"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Does climate influence cetacean distributions across the UK?

This is an R markdown document for the cetacean strandings project. It includes: 

- The main questions that are being asked in my first chapter 
- My attempt to begin asking them
- An idea of the code I have used
- An idea of the plots I will produce and would like to produce 


##Questions 

##A. Cetacean distributions across the UK through time 
###i. Species abundance 
###ii. Species richness 
###iii. Species diversity 
###iiii. Species changes 

##B. Link to sea surface temperature (SST)

##C. Interesting side questions 
###i. Current seasonal changes in cetacean distributions 
###ii. Cross-validation of data: live survey data, bycatch data and whaling data 

##D. The 'boring' questions 
###i.Sampling effort - county data - need to work out how to get this on the hex plots 
###ii. Sampling bias - Basic plot (specific species/all species for that year)


NB. This doucment does not contain details on the data clean-up of the strandings data that occurred earlier in the project.
Code for cleaning data is ![(available on my GitHub page)](https://github.com/EllenJCoombs/strandings-project)

To open plots in MAC OS X 
```{r, include=FALSE}
options(device="quartz")
options(device="x11")

```

All analysis uses the data: "cleandatesnames.csv"
Required packages are put in each section so that each section can be run seperately 

##A. Cetacean distributions across the UK through time 

The first part of this chapter will be an overview of the strandings data, including overall species richness, diveristy and abundance. 

There will then be a more focused look at:
a) particular species of interest (see Excel document: "Stranding analysis")
b) A focus on the years post 1970: abundance, richness and diversity 
c) Spatial and temporal changes 

###ii. Abundance - overall and temporally  
Firstly, some simple manipulation of the data i.e. species counts 

The following code can be manipulated to look at abundance and diversity for any target species - at any time point/period 
```{r, include=FALSE}

library(dplyr)
library(ggplot2)

#Some simple count data - some prep of the data to approach question A. 

data <- read.csv("cleaned-data/cleandatesnames.csv")
names(data)

#Getting rid of the extra X1 column - not sure where this comes from 
cleaneddata <- select(data, Name.Current.Sci, Name.Common, Latitude, Longitude, County, Year, Date) 
levels(cleaneddata$Name.Current.Sci)

#SPECIES ABUNDANCE 

#Having a look at how many of each species 
select(cleaneddata, Name.Current.Sci)
#'Species' just looking at Name.Current.Sci
species <- count(cleaneddata, Name.Current.Sci)
#'Speciesyearcount' cleaned data: a count of current scientific name and year 
speciesyearcount <- count(cleaneddata, Name.Current.Sci, Year)
species_lat <- count(cleaneddata, Name.Current.Sci, Latitude)

#This is just species and the year - no counting or sorting 
speciesyear <- select(cleaneddata, Year, Name.Current.Sci)
```

```{r, include=FALSE}
#Geom_line of all species for every year 
ggplot(data = speciesyearcount, aes(x = Year, y = n, colour= Name.Current.Sci))+
  theme(panel.background = element_blank(), panel.border = element_rect(colour = "grey40", fill = NA)) +
  labs(x = "Year", y = "Species count") +
  geom_line() +
  scale_fill_manual(values=c("deeppink", "steelblue"), guide=FALSE) + 
  facet_wrap(~ Name.Current.Sci)
```

```{r, include=FALSE}
#Seperate species by year
ggplot(speciesyear, aes(x = Year, fill = Name.Current.Sci)) +
  geom_histogram(binwidth = 0.5)

#All species histograms seperated with better bin widths 
ggplot(speciesyear, aes(x = Year)) +
  geom_histogram(binwidth = 0.5) +
  facet_wrap(~ Name.Current.Sci)
```

```{r, include=FALSE}
#Looking at species by year - a count of each species per year
speciesbyyear <- aggregate(n ~ Name.Current.Sci, speciesyearcount, sum)
#Arranging species by year by count 
speciesbyyear <- speciesyearcount %>%
  group_by(n, Year, Name.Current.Sci) %>%
  arrange(Year)
```

###Abundance - spatial data (maps)
I have chosen to put an example here - these plots can easily be made for any species either as one plot (total strandings) or strandings through time 

This plot shows all species but can easily be manipulated to show just one, or several species
```{r, include =FALSE}

#Hexagonal plot - all species 
library(viridis)
library(tidyverse)
library(ggmap)
library(sp)
library(ggfortify)
library(maps)
library(mapdata)

# Extract UK map
#Added Ireland 
uk <- map_data("world", regions = c('UK', 'Ireland'))

# Create base map
gg1 <- 
  ggplot() + 
  geom_polygon(data = uk, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") + 
  coord_fixed(1.3) 

# Read in the strandings data
ds <- read.csv("cleaned-data/cleandatesnames.csv")

# Remove NAs from coordinates
# And restrict to things in UK waters
#Filter species here too 
ds <- ds %>%
  filter(!is.na(Latitude) & !is.na(Longitude)) %>%
  filter(Latitude < 65 & Latitude > 45) %>%
  filter(Longitude < 3 & Latitude > -8) 

# Basic plot using viridis colour scheme
# Note that you can change bins and transparency
gg1+
geom_hex(data = ds, aes(y = Latitude, x= Longitude), bins = 25, alpha = 0.5) +
scale_fill_gradientn(colours = viridis(4))

#More complex plot, with axes removed, smaller bins, defined colours, and simpler legend
gg1+
  geom_hex(data = ds, aes(y = Latitude, x= Longitude), bins = 100, alpha = 0.5) +
  scale_fill_gradientn(colours = c("blue", "red")) +
  theme(axis.line  = element_blank(),
        axis.text  = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(fill = guide_colorbar(title = NULL, ticks = FALSE))

#values for each of the hexagons...

gg2 <- gg1+
geom_hex(data = ds, aes(y = Latitude, x= Longitude), bins = 100, alpha = 0.5) +
scale_fill_gradientn(colours = viridis(4))

pg <- ggplot_build(gg2)

#Look at this object
pg

#Hex values are in pg$data[[2]]$count
pg$data[[2]]$count

```

###Abundance - temporal 
Simple plots of each of the species abundance through time 
```{r, include =FALSE}
library(readr)
library(ggplot2) 
library(gridExtra)

# Plot whale occurrences through time
whale_years_plot <- function(data, species.name = NULL, binwidth = 0.5, 
                             start.date = 1913, end.date = 2017){
  
  ggplot(data, aes(x = Year)) +
    geom_histogram(binwidth = binwidth) +
    xlim(start.date, end.date) +
    theme_bw() +
    labs(title = species.name)
}

# Choose one species from dataset
# Input name of the column with the species data
# and the name of the species (both in quotation marks)
choose_species <- function(data, species.col.no, species.name){
  data[which(data[, species.col.no] == species.name), ]
}

# Select a list of all whale species in the strandings dataset
# Currently this deletes NAs but does not fix "unknowns" etc.
# Replace unknowns with NA when cleaning data
whale_list <- function(data, species.col){
  # Extract column number of species column
  species.col.no <- which(names(data) == species.col)
  # Get list of whale species
  whales <- unique(data[, species.col.no])
  # Unlist so this is a list of species not a dataframe
  whales <- unlist(whales, use.names = FALSE)
  # Remove NAs
  whales[!is.na(whales)]
}

# Plot all the plots for all the whales
# year = name of date variable, not in quotation marks
# species.name = name of the species if looking at only one
# binwidth = width of bins in histogram
# start.date and end.date - allows you to change the plotting window years
# species.col = name of the column with the species data in quotation marks
# whales = a vector of names of the whales you want to plot
# requires library(gridExtra)
# requires library(ggplot2)
plot_all_whale_years <- function(data, species.col, whales,
                                 binwidth = 0.5, start.date = 1913, end.date = 2017){
  
  # Extract column number of species column
  species.col.no <- which(names(data) == species.col)
  
  # Make an empty list to put graphs into
  whale.graph.list <- list()
  
  # Loop through each of the whales in the list
  for(i in seq_along(whales)){
    
    # Select one whale
    one.whale.name <- whales[i]
    one.whale <- choose_species(data, species.col.no, one.whale.name)
    
    # Plot the graph
    whale.graph.list[[i]] <- 
      whale_years_plot(one.whale, species.name = one.whale.name, binwidth, 
                       start.date, end.date)
  } # end loop
  
  # Plot all the plots in whale.graph.list
  do.call(grid.arrange, whale.graph.list)
  
}

# EXAMPLE
library(ggplot2)
library(gridExtra)

# Read in the data
ds <- read.csv("cleaned-data/cleandatesnames.csv")

# This would get a full list of the whale species
# But for now we just want a couple as an example
# whales <- whale_list(ds, "Name.Current.Sci")

#If I want to look at all whales 
whales <- whale_list(ds, "Name.Current.Sci")

#If I want to look at just these species 
whales <- c("Delphinus delphis", "Phocoena phocoena", "Kogia sima", "Orcinus orca")

# Plot graphs
plot_all_whale_years(ds, species.col = "Name.Current.Sci", whales,
                     binwidth = 0.5, start.date = 1913, end.date = 2017)

```

Can be done for any species - Here are some examples for Mysticetes, Odontocetes, Beakers and bycatch candidates 

```{r, include =FALSE}
#Mysitcetes 
mysticetesplot <- c("Balaenoptera acutorostrata", "Balaenoptera borealis", "Balaenoptera musculus", "Balaenoptera physalus", 
                    "Megaptera novaeangliae", "Unknown balaenoptera",
                    "Unknown mysticete") 
                  
plot_all_whale_years(ds, species.col = "Name.Current.Sci", mysticetesplot,
                     binwidth = 0.5, start.date = 1913, end.date = 2017)

```

```{r, include =FALSE}
#unknowns 
unknowns <- c("Unknown odontocete", "Unknown mysticete", "Unknown", "Unknown balaenoptera", "Unknown delphinid")
plot_all_whale_years(ds, species.col = "Name.Current.Sci", unknowns,
                     binwidth = 0.5, start.date = 1913, end.date = 2017)
```

```{r, include =FALSE}
#Beaked and bottlenose whales ########################################################
beakers <- c("Hyperoodon ampullatus", "Mesoplodon densirostris", "Mesoplodon europaeus", "Mesoplodon mirus")
plot_all_whale_years(ds, species.col = "Name.Current.Sci", beakers,
                     binwidth = 0.5, start.date = 1913, end.date = 2017) 
```

```{r, include =FALSE}
#Bycatch candidates 
bycatch_candidates <- c("Phocoena phocoena", "Delphinus delphis", "Tursiops truncatus")
plot_all_whale_years(ds, species.col = "Name.Current.Sci", bycatch_candidates,
                     binwidth = 0.5, start.date = 1913, end.date = 2017) 
```

###Temporal and spatial changes 
Decadal maps for all species, and decadal maps for certain species
Individual species can easily be plotted using a modification of the below code. I will also plot these for the data after 1970 only 
```{r, include=FALSE}

#This is Natalie's code 
## Some code to make maps for each decade and plot in the same
# plotting window
# Load libraries 
library(ggplot2)
library(tidyverse)
library(mapdata)
library(gridExtra)

#Had to install this to get it running - no idea why - was running fine before without 
#install.packages("mapproj")
library(mapproj)
# Read in the strandings data
nhmcsip <- read.csv("cleaned-data/cleandatesnames.csv")
# Extract map data
uk <- map_data("world", regions = c('UK', 'Ireland'))
# Create base map
base.map <- 
  ggplot() + 
  # Add country polygons
  geom_polygon(data = uk, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") + 
  # Define coordinates to plot between
  coord_map(xlim = c(-11, 3), ylim = c(49, 60.9)) +
  # Remove grey background
  theme_bw() +
  # Remove x and y axes labels and tick marks
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
# Create a list for the start years of each decade
decades <- c(seq(from = 1913, to = 2003, by = 10), 2013)
# Make an empty list that you're going to put all your
# ggplot maps into
map.list <- list()
# Loop through each of the starting years in "decades"
for(i in seq_along(decades)){
  
  # Define the start and end year of the decade
  start.year <- decades[i]
  end.year <- decades[i] + 9
  # Add a short if statement so that you don't go into the future!
  if(end.year > 2017){
    end.year <- 2017
  }

  
  # Use filter to select just the records for that decade
  one.decade <- filter(nhmcsip, Year >= start.year & Year <= end.year)
  
  # Add the points to the base map
  # Create a different map for each decade with a different name
  # placed into map.list
  map.list[[i]] <- 
    base.map +
    geom_point(data = one.decade, aes(x = Longitude, y = Latitude),
               color = "red", size = 0.5) +
    # Add title with years covered
    labs(title = paste(start.year, "-", end.year))
} # end loop
# Plot all the plots in map.list
do.call(grid.arrange, map.list)
```

###Heat map of all species 
Individual species can easily be plotted using a modification of the below code 
This code plots heatmaps of species diversity through time and currently incorporates indiviudal species 
```{r, include=FALSE}
library(rgdal)         # for readOGR(...)

sample <- data.frame(Longitude=c(-1+rnorm(50,0,.5),-2+rnorm(50,0,0.5),-4.5+rnorm(50,0,.5)),
                     Latitude =c(52+rnorm(50,0,.5),54+rnorm(50,0,0.5),56+rnorm(50,0,.5)))
UKmap <- readRDS("/Users/ellencoombs/Desktop/Projects/Strandings/data/GBR_adm2 (1).rds")
IRmap <- readRDS("/Users/ellencoombs/Desktop/Projects/Strandings/data/IRL_adm1.rds")
map.df <- fortify(UKmap)
ir.df <- fortify(IRmap)

#Adds long and lat points 
points <- data.frame(
  long = counts$Longitude,
  lat = counts$Latitude,
  count = counts$n)

ggplot(points, aes(x = long, y = lat)) + 
  stat_density2d(aes(fill = ..level..), alpha = 1, geom ="polygon") +
  geom_point(colour = "black", size = 0.5)+
  geom_path(data = map.df, aes(x = long, y = lat, group = group), colour ="grey50") +
  geom_path(data = ir.df, aes(x = long, y = lat, group = group), colour ="grey50") +
  scale_fill_gradient2(low = "blue", mid = "yellow", high = "red", space = "Lab", 
  na.value = "grey50", guide = "colourbar") +
  xlim(-10,+2.5) +
  coord_map(xlim = c(-11,3), ylim = c(49,60.9))

```

###Species heatmaps - example: Lagenorynchus acutus (White-sided dolphin)
I have produced decadal heatmaps to look at temporal changes over time 
- The resolution on these is not particularly good - see latitude graphs below for an alternative 
- Can be produced for any species using the below code 
```{r, include=FALSE}

#Having a go at plotting species decadal heatmaps 
library(dplyr)
library(ggplot2)
library(tidyverse)
library(mapdata)
#Had to install this to get it running - no idea why - was running fine before without 
library(mapproj)
library(grid)

cleaneddata <- read.csv("cleaned-data/cleandatesnames.csv")

#Select species 
L_acutus <- cleaneddata %>%
  filter(Name.Current.Sci == "Lagenorhynchus acutus")

# Extract map data
uk <- map_data("world", regions = c('UK', 'Ireland'))
# Create base map
base.map <- 
  ggplot() +
  # Add country polygons
  geom_polygon(data = uk, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") + 

# Create a list for the start years of each decade
decades <- c(seq(from = 1913, to = 2003, by = 10), 2013)
# Make an empty list that you're going to put all your
# ggplot maps into
map.list <- list()
# Loop through each of the starting years in "decades"
for(i in seq_along(decades)){
  
  # Define the start and end year of the decade
  start.year <- decades[i]
  end.year <- decades[i] + 9
  # Add a short if statement so that you don't go into the future!
  if(end.year > 2017){
    end.year <- 2017
  }
  
  
  # Use filter to select just the records for that decade
  one.decade <- filter(L_acutus, Year >= start.year & Year <= end.year)
  
  # Add the points to the base map
  # Create a different map for each decade with a different name
  # placed into map.list
  map.list[[i]] <- 
    ggplot(data = one.decade, aes(x = Longitude, y = Latitude)) + 
    stat_density2d(aes(fill = ..level..), alpha = 1, geom ="polygon") +
    geom_polygon(data = uk, aes(x = long, y = lat, group = group), 
                 fill = "white", color = "black") +
    scale_fill_gradient2(low = "blue", mid = "yellow", high = "red", space = "Lab", 
                         na.value = "grey50", guide = "colourbar") +
    coord_map(xlim = c(-11, 3), ylim = c(49, 60.9)) +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) +
   labs(title = paste(start.year, "-", end.year))
} # end loop
# Plot all the plots in map.list
do.call(grid.arrange, map.list)
```

###ii. Species richness 
i.e. Number of species present 
Species richness increases with sample size, and differences in richness actually may be caused by differences in sample size. To solve this problem, we may try to rarefy species richness to the same number of individuals.

```{r, include=FALSE}

library(vegan)
library(picante)

cleaneddata <- read.csv("cleaned-data/cleandatesnames.csv")

#Need to reorder the data
reordering <- speciesbyyear[c("Year", "n", "Name.Current.Sci")]
whale.matrix <- sample2matrix(reordering)

#Number of species per year (prints out values)
specnumber(whale.matrix)

#Species per year (this incorporates NAs)
total_speciesbyyear <- aggregate(speciesbyyear$n, by = speciesbyyear[c('Year')], length)
```

```{r, include=FALSE}
#Histogram of species richness 
ggplot(data = speciesbyyear, aes(x = Year)) +
  geom_histogram(binwidth = 0.5)
```

```{r, include=FALSE}
#plot of total species per year 
ggplot(data = total_speciesbyyear, aes(x = Year, y = x)) +
  theme(panel.background = element_blank(), panel.border = element_rect(colour = "grey40", fill = NA)) +
  labs(x = "Year", y = "Species count") +
  geom_smooth() +
  geom_line()
```

###iii. Species diversity 
```{r, include=FALSE}
#Simpson's diversity index 
simpson <- diversity(whale.matrix, index = "simpson")
plot(simpson)

#Simpson's Diversity Index is a measure of diversity which takes into account the number of species present, as well as the relative abundance of each species. As species richness and evenness increase, so diversity increases.
#The value of D ranges between 0 and 1. With this index, 1 represents infinite diversity and 0, no diversity.
#Yearly: 0.5-0.8 for the stranding data 

#Shannon's diversity index 
shannon <- diversity(whale.matrix, index = "shannon")
plot(shannon)

#Shannon's index accounts for both abundance and evenness of the species present. Typical values are generally between 1.5 and 3.5 in most ecological studies, and the index is rarely greater than 4. The Shannon index increases as both the richness and the evenness of the community increase.
#Yearly: 1.5-2.5, drops slightly over the decade

#Beta diversity
betadiver(help=TRUE)
betadiver(whale.matrix, method = "j")
betadiver(whale.matrix, method = "sor")
betadiver(whale.matrix, method = "w")

#Gamma diversity 
length(unique(speciesbyyear$Name.Current.Sci))

#This adds up species where abundance is not NA
length(unique(speciesbyyear$Name.Current.Sci[!is.na(speciesbyyear$n) & speciesbyyear$n != 0]))
```


```{r, include=FALSE}
#Used years as sites 
#This plots each of the years as a "site" as would be in a normal rarefaction curve 
rarecurve(whale.matrix)
```


###Species accumulation curves
Practiced with lots of different permutations - have only put the 1000 example here (others were less useful, of course!)
```{r, include=FALSE}
#Species accumulation curves 
whale.curve <- specaccum(whale.matrix, method = "random", permutations = 1000)
whale.curve

plot(whale.curve, ci.type = "poly", col = "blue", ci.col = "lightblue", 
     lwd = 2, ci.lty = 0, xlab = "Years: 1913 - 2015", 
     ylab = "Cumulative number of whale species")
```


Chao2
```{r, include=FALSE}
specpool(whale.matrix)
```
Species     chao  chao.se    jack1 jack1.se    jack2     boot  boot.se   n
All            33 35.64078 3.455292 36.96117 2.429669 37.97059 35.00546 1.346503 103

Chao2 - 35/36?? Number of species 

###iiii. Species changes 
Here, I decided to look at any changes in spatial distribution using counts per latitude (degrees parallel north) over the century for individual species, and for all species together

This was done for specific, individual species but can easily be done for any species 
- Gives an idea of species distribution 

Example here is Grampus griseus (Risso's dolphin)
```{r, include=FALSE}
library(dplyr)
library(gridExtra)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(magrittr)

cleaneddata <- read.csv("cleaned-data/cleandatesnames.csv")

species_lat <- dplyr::count(cleaneddata, Latitude, Name.Current.Sci, Year) 

#removing the 0.0000 lats and 
species_lat <- species_lat %>%
  filter(Latitude > 49.00000) %>%
  filter(Latitude < 62.00000)


#This bit is for playing around with specific species 
G_griseus_lat <- species_lat %>% 
  filter(Name.Current.Sci == "Grampus griseus")

# Create a list for the start years of each decade
decades <- c(seq(from = 1913, to = 2003, by = 10), 2013)
# Make an empty list that you're going to put all your
# ggplot plots into
plot.list <- list()
# Loop through each of the starting years in "decades"
for(i in seq_along(decades)){
  # Define the start and end year of the decade
  start.year <- decades[i]
  end.year <- decades[i] + 9
  # Add a short if statement so that you don't go into the future!
  if(end.year > 2017){
    end.year <- 2017
  }
  
 # Use filter to select just the records for that decade
  one.decade <- filter(G_griseus_lat, Year >= start.year & Year <= end.year)
  
  
  # Add the points to a plot 
  # Create a different plot for each decade with a different name
  # placed into map.list
  plot.list[[i]] <- 
    ggplot(one.decade, aes(x = Latitude)) +
    geom_histogram(binwidth = 0.1) + 
    labs(title = paste(start.year, "-", end.year))
    
} # end loop
# Plot all the plots in map.list
do.call(grid.arrange, plot.list)


```


##B. Link to sea surface temperature (SST)
Still working on this - looking at HadISST1 data (UK SST 1870-present monthly) and EN4 data (UK water column and salinity 1900 - present)

Have written some of the code for this but can't get it working 

##C. Interesting side questions 
###i. Current seasonal changes in cetacean distributions 
I have been playing with code to split up data into monthly strandings (total, all species, or for individual species) and also quarterly counts which could be used for looking at seasonal changes 

I used the 'zoo' package to do this 
This example looks at miltary testing and beaker strandings, but can easily be manipulated to look at any species strandings for any time period 

Code is below, but I am still working on it....
```{r, include=FALSE}
library(zoo)
library(dplyr)

#To add 

```

###ii. Cross-validation of data: live survey data, bycatch data and whaling data 
Whaling data obtsined from IWC for Blue, Fin, Sei, Right, Bottlenose, Minke, Humpback, Sperm, and 'others' I chose to only look at the stranding data for these species here

'Hunted-stranders' therefore refers to species that have stranded, and were/are also hunted 

Data from the North Atlantic - this is cumulative (Ireland, Scotland, Norway and Iceland)
```{r, include=FALSE}
library(dplyr)
library(ggplot2)

#Cross validation with whaling data 
#Looking at whether the whaling data is consistent with the stranding data 
#Blue, Fin, Sei, Right, Bottlenose, Minke, Humpback, Sperm, others 

whaling <- read.csv("cleaned-data/North_Atlantic_whaling.csv")
View(whaling)

#Selecting the species and the year 
whaling_species <- whaling %>%
  select(Year, Balaenoptera.musculus, Balaenoptera.physalus, 
         Megaptera.novaeangliae, Balaenoptera.borealis, Physeter.macrocephalus, 
         Others, Eubalaena.glacialis, Hyperoodon.ampullatus, Balaenoptera.acutorostrata, 
         Total.catch)

#Want to rename the columns to match species name in other plots 
whaling_species <- rename(whaling_species, "Balaenoptera physalus" = "Balaenoptera.physalus", 
       "Balaenoptera musculus" = "Balaenoptera.musculus",
       "Megaptera novaeangliae" = "Megaptera.novaeangliae",
       "Balaenoptera borealis" = "Balaenoptera.borealis",
       "Physeter macrocephalus" = "Physeter.macrocephalus", 
       "Eubalaena glacialis" = "Eubalaena.glacialis", 
       "Hyperoodon ampullatus" = "Hyperoodon.ampullatus",
       "Balaenoptera acutorostrata" = "Balaenoptera.acutorostrata")

#Plotting species and year 
library("reshape2")
library(RColorBrewer)

whaling_plot <- melt(whaling_species, id="Year")  # convert to long format

#Renaming the columns 
whaling_plot <- rename(whaling_plot, Count = value, 
       Name.Current.Sci = variable)
```

```{r, include=FALSE}
library(ggplot2)
library(dplyr)

#Plotting all catch, North Atlantic + Total catch 
ggplot(data = whaling_plot,
       aes(x = Year, y = Count, colour = Name.Current.Sci, ylab = "Count")) +
  geom_line() +
  facet_wrap(~ Name.Current.Sci) 

#Want to order the data by year (not species as it currently is) 
whaling_plot %>%
  arrange(Year)

#Need to remove "Total.Catch" column" 
whaling_species_no_total <- whaling_species %>%
  select("Year", "Balaenoptera musculus", "Balaenoptera physalus", 
         "Megaptera novaeangliae", "Balaenoptera borealis", "Physeter macrocephalus", 
         "Others", "Eubalaena glacialis", "Hyperoodon ampullatus", "Balaenoptera acutorostrata")


#If I want to look at total killed - just look at "Total.catch" in the "whaling_species")

#Stripping out the same species from the stranding data (those that were hunted)
hunted_stranders <- cleaneddata %>% 
  filter(Name.Current.Sci %in% c("Balaenoptera musculus", "Balaenoptera physalus", 
                                 "Megaptera novaeangliae", "Balaenoptera borealis", 
                                 "Physeter macrocephalus", "Eubalaena glacialis", 
                                 "Hyperoodon ampullatus", "Balaenoptera acutorostrata"))

#Aggregating by year 
hunted_strandersyear <- count(hunted_stranders, Name.Current.Sci, Year)

#Arranging species by year by count 
hunted_stranders_total <- hunted_strandersyear %>%
  group_by(n, Year, Name.Current.Sci) %>%
  arrange(Year)
```

Plotting total stranded whales of species that are hunted 
```{r, include=FALSE}

library(ggplot2)
library(dplyr)


ggplot(data = hunted_stranders_total,
       aes(x = Year, y = n, colour = Name.Current.Sci, ylab = "Count")) +
  geom_line() +
  facet_wrap(~ Name.Current.Sci) 

#The totals of stranded whales (that were hunting candidates) stranding each year
Total_hunted_stranders <- aggregate(n ~ Year, hunted_stranders_total, sum)
#Total hunted each year (and only looking at 1913 - 2015)
Total_hunted <- whaling %>% 
  select(Year, Total.catch) %>%
  filter(Year %in% c(1913:2015))

#Want to plot total whaled and total strandings of hunted species 
#Changing the total.catch column to n 
Total_hunted_rename <- rename(Total_hunted, n = Total.catch)

#Plotting total hunted and total strandeds (of hunted species)
#Not sure this works...need to have another look 
#ggplot(Total_hunted_stranders$n*100, aes(x = Year, y = n, ylab = "Count")) + geom_line(aes(color = "Strandings"))+
  #geom_line(data = Total_hunted_rename, aes(color="Hunted")) +
  #scale_y_continuous(sec.axis = sec_axis(~.*100))
  #labs(color = "Stranding and hunting data") 

  
#Bind the two datasets (Total_hunted and Total_hunted_stranding)
#Clean up the data 
Catch_and_strandings <- bind_cols(Total_hunted, Total_hunted_stranders) %>%
  select(Year, Total.catch, n) %>%
  rename("Strandings" = "n")

#Plot them both on the same graph 
  p <- ggplot(Catch_and_strandings, aes(x = Year))
  p <- p + geom_line(aes(y = Strandings, colour = "Total strandings"))
  
  # adding the stranding data, transformed to match roughly the range of the total catch
  p <- p + geom_line(aes(y = Total.catch/20, colour = "Total catch"))
  
  # now adding the secondary axis, following the example in the help file ?scale_y_continuous
  # and, very important, reverting the above transformation
  p <- p + scale_y_continuous(sec.axis = sec_axis(~.*20, name = "Total catch"))
  
  # modifying colours and theme options
  p <- p + scale_colour_manual(values = c("blue", "red"))
  p <- p + labs(y = "Total stranding",
                x = "Year",
                colour = "Parameter")
  p <- p + theme(legend.position = c(0.8, 0.9))
  p  
  
  
  
#This code attempts to add some key events to the above plot - ugly! Need to clean 
#Attempting to add arrows to the stranding data and whaling graph 

#Whaling and stranding plot data 

#Using "Catch_and_strandings" dataset (see "Whaling_code.R" for details)

library(ggplot2)
library(grid)
library(tidyverse)

#This plot adds the two war periods
p <- ggplot(Catch_and_strandings, aes(x = Year))
p <- p + geom_line(aes(y = Strandings, colour = "Total strandings"))

# adding the stranding data, transformed to match roughly the range of the total catch
p <- p + geom_line(aes(y = Total.catch/20, colour = "Total catch"))

# now adding the secondary axis, following the example in the help file ?scale_y_continuous
# and, very important, reverting the above transformation
p <- p + scale_y_continuous(sec.axis = sec_axis(~.*20, name = "Total catch"))

# modifying colours and theme options
p <- p + scale_colour_manual(values = c("blue", "red"))
p <- p + labs(y = "Total stranding",
              x = "Year",
              colour = "Parameter")

#p <- p + annotate("segment", x = 0, xend = -0, y = 0, yend = -20, colour="blue", size=2, arrow=arrow())

#p <- p + geom_vline(xintercept = 1914, linetype="dotted", 
                #color = "blue", size=1.5)

#p <- p + theme(legend.position = c(0.9, 0.1)) 

#Putting the legend outside the plot 
p <- p + theme(legend.justification = "top")

#This code adds shaded areas to the plot 
#WWI
p <- p + annotate("rect", xmin=1914, xmax=1918, ymin=0, ymax=60, alpha=.2, fill="gray44") +
geom_text(
  aes(x = 1916, y = 60, label = "WWI"), size = 3)

#WWII
p <- p + annotate("rect", xmin=1939, xmax=1945, ymin=0, ymax=60, alpha=.2, fill="gray44") +
  geom_text(
    aes(x = 1942, y = 60, label = "WWII"), size = 3)

#Moratorium 1986
p <- p + annotate("rect", xmin=1985, xmax=1986, ymin=0, ymax=60, alpha=.5, fill="gray44") +
  geom_text(
    aes(x = 1985, y = 60, label = "Moratorium comes into effect:
1985/1986 season start"), size = 3)

#Catches under objection 
p <- p + annotate("rect", xmin=1986, xmax=2015, ymin=0, ymax=60, alpha=.2, fill="gray44") +
  geom_text(
    aes(x = 1997, y = 50, label = "Norway and Iceland 
        continue to hunt
        under objection "), size = 3)

#This code adds arrows to the plot 
#CSIP
p <- p + annotate("segment", x = 1990, xend = 1990, y = 0, yend = -10, colour="black", size=0.5, arrow=arrow(length=unit(0.1,"cm"))) + 
  geom_text(
    aes(x = 1985, y = -12, label = "CSIP programme starts"), size = 3)

p <- p + annotate("segment", x = 1945, xend = 1950, y = 0, yend = -10, colour="black", size=0.5, arrow=arrow(length=unit(0.1,"cm"))) + 
  geom_text(
    aes(x = 1945, y = -14, label = "Increase in post-war
        fishing & whaling effort"), size = 3)


  
  
```
  
Each species stranding and whaling on the same plot - split by facet_wrap species
- This is for cross-validation of data 
```{r, include=FALSE}

#Need "iwc" and "hunted_stranders_total" 
#Each species seperately...?
  
iwc <- whaling_species_no_total
  
library(reshape2)
install.packages("mvbutils")
library(mvbutils)
  
#Arranging by species for catch data 
iwc$X <- NULL
iwc <- melt(iwc, measure.vars=names(iwc)%except%"Year") 

iwc <- iwc %>% 
  rename(Name.Current.Sci = variable) %>%
  rename(Catch = value) %>% 
  arrange(Year)

#Clean up hunted_stranders_total
hunted_stranders_total <- hunted_stranders_total %>%
  rename(Strandings = n)

#Plot the data together 
ggplot() + 
  geom_line(data = hunted_stranders_total, aes(x = Year, y = Strandings, colour = "Strandings")) +
  geom_line(data = iwc, aes(x = Year, y = Catch/20, colour = "Hunted")) +
  scale_y_continuous(sec.axis = sec_axis(~.*20, name = "Total catch")) +
  labs(y = "Total stranding",
              x = "Year",
              colour = "Parameter") +
  facet_wrap(~ Name.Current.Sci)

```


Here, I am looking at whether there is a relationship between hunted and stranded species - with regression 

```{r, include=FALSE}

#Fitting a regression line to whaling and catch data
#First, havingg to add a 'total per year' to each dataset 

#'Total_hunted' = total hunted (blue, fin, sei, minke, humpback, sperm, bottlenose)
#'Total-hunted_stranded' (of the abov species that were both hunted and stranded as well)

library(devtools)
library(dplyr)


hunted_and_stranded <- bind_cols(Total_hunted, Total_hunted_stranders)

#Renaming the columns 

hunted_and_stranded <- hunted_and_stranded %>%
  dplyr::rename("Catch" = Total.catch) %>%
  dplyr::rename("Stranded" = n) %>%
  select("Year", "Catch", "Stranded")

#Plot both on the same graph
#Have done log calc but not sure if it needed it (can also remove this and do non log
#calculation)

#Regression line 
a1 <- ggplot(data = hunted_and_stranded, aes(x = Stranded, y = Catch)) +
  geom_point(size = 0.5) +
  geom_text(aes(label = Year), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) +
  labs(x = "Total stranded", y = "Total catch (hunted)") #se=FALSE, colour = "grey70", size =0.7) 

a1

m <- lm(Stranded ~ Catch, data = hunted_and_stranded)
a <- signif(coef(m)[1])
b <- signif(coef(m)[2])
textlab <- paste("y = ",b,"x + ",a, sep="")

a2 <- a1 + geom_smooth(method = lm, formula = y~x) 

a3 <- a2 + geom_text(aes(x = 35, y = 150, label = textlab), color="black", size=5, parse = FALSE)  

plot(a3)


##############################################
#After 1970 only with regression line 

hunted_and_stranded1970 <- hunted_and_stranded %>% 
  filter(Year %in% c(1986:2015))

b1 <- ggplot(data = hunted_and_stranded1970, aes(x = Stranded, y = Catch)) +
  geom_point(size = 0.5) +
  geom_text(aes(label = Year), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) +
  labs(x = "Total stranded", y = "Total catch (hunted)") #se=FALSE, colour = "grey70", size =0.7) 


#m <- lm(hunted_and_stranded1970$Stranded ~ hunted_and_stranded1970$Catch)
m <- lm(Stranded ~ Catch, data = hunted_and_stranded1970)
a <- signif(coef(m)[1])
b <- signif(coef(m)[2])
textlab <- paste("y = ",b,"x + ",a, sep="")

b2 <- b1 + geom_smooth(method = lm, formula = y~x) 

b3 <- b2 + geom_text(aes(x = 35, y = 150, label = textlab), color="black", size=5, parse = FALSE)  

plot(b3)


```










- I want to be able to add bycatch data to the above plots but am having trouble finding the data 
- Same with live sightings data - have spoken to Tom Webb and emailed Peter Evans 
  - OBIS-Seamap is static, have been told to use JCP but this is also static 

##D. The 'boring' questions 
###i.Sampling effort - county data - need to work out how to get this on the hex plots 

UK population plots 
Can I get an idea of regional population change by looking at the overall country population? 

```{r, include=FALSE}
#Looking at UK population as a means of assessing sampling effort 
#Step one is to see how regional data compares to total population data
#I.e. can I used total population data, or would that not reflect regional changes? 

library(dplyr)

#Read in the proto-population data (need to make this more detailed e.g. by county, see below)
library(reshape2)
library(mvbutils)
library(ggplot2)
#Check.names removes the X that randomly appeared (not sure what that was)
population_data <- read.csv("cleaned-data/Population_data.csv", check.names = FALSE)

#Arranging data in to years, locality and population 
population_data$X <- NULL
population_data <- melt(population_data, measure.vars=names(population_data)%except%"Name")

population_data <- population_data %>% 
  rename(Year = variable) %>%
  rename(Population = value) 

population <- population_data$Population 

#Transforming population to numeric (was in "")
population <- gsub(",","", population)
population_data <- mutate(population_data, Population = as.numeric(Population))

as.numeric <- population

#Checking that it's numeric 
sapply(population_data, class)
#Log transformation 

#plotting population data 
#Need to log the population data 
ggplot() + 
  geom_line(data = population_data, aes(x = Year, y = Population, colour = Name, group = factor(Name))) +
  labs(x = "Year", y = "Population") + 
  geom_smooth (method=lm, se=FALSE, colour = "grey70", size =0.7)
  #coord_cartesian(ylim = c(1,000,000, 60,000,000))

```

  
```{r, include=FALSE}
library(dplyr)
#Read in the proto-population data (need to make this more detailed e.g. by county, see below)
library(reshape2)
library(mvbutils)
library(ggplot2)

#Doesn't show much - split out the data fpr larger and smaller populations and put on a
#seperate y-axis 
large_pops <- population_data %>% 
  filter(Name %in% c("UNITED KINGDOM", "ENGLAND", "ENGLAND & WALES", "GREAT BRITAIN"))

#Not sure why the below didn't work 
#small_pops <- population_data[ !(population_data$Name %in% large_pops$Name), ]

small_pops <- population_data %>% 
  filter(Name %in% c("EAST", "EAST MIDLANDS", "LONDON", "NORTH EAST", "NORTH WEST", "NORTHERN IRELAND","SCOTLAND", "SOUTH EAST", "SOUTH WEST", "WALES", "WEST MIDLANDS", "YORKSHIRE AND THE HUMBER"))


#Plot both with two different axis
#This isn't right
#ggplot() +
  #geom_point(data = small_pops, aes(x = Year, y = Population, colour = "Regions")) +
  #geom_point(data = large_pops, aes(x = Year, y = Population/100, colour = "Countries")) +
  #scale_y_continuous(sec.axis = sec_axis(~.*100, name = "Total population")) +
 #labs(y = "Regional Population",
       #x = "Year") 

```


Looking in a little more detail at county vs. country data
These regions were selected at random from all counties that were not land-locked 
```{r, include=FALSE}
library(dplyr)
library(reshape2)
library(mvbutils)
library(ggplot2)
library(ggplot2)
library(dplyr)
#Comparing UK population with UK county data 

uk_counties <- read.csv("cleaned-data/Country_county_population.csv", header = TRUE)

#Cleaning up the data quickly 
uk_counties <- uk_counties %>%
  select("YEAR", "UK", "CORNWALL", "DEVON", "HAMPSHIRE", "KENT", "CEREDIGION", "NORFOLK", "WEST.LANCASHIRE",
         "NORTHUMBERLAND", "ARGYLL", "HIGHLAND") 


uk_counties <- uk_counties %>% 
  filter(YEAR %in% c(1991:2009))

#Having a look at county fluctuations compared to UK 
library(Rmisc) #for the multiplot function 

c1 <- ggplot(data = uk_counties, aes(x = CORNWALL, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Cornwall population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c2 <- ggplot(data = uk_counties, aes(x = DEVON, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Devon population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 
  

c3 <- ggplot(data = uk_counties, aes(x = HAMPSHIRE, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Hampshire population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c4 <- ggplot(data = uk_counties, aes(x = KENT, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Kent population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c5 <- ggplot(data = uk_counties, aes(x = CEREDIGION, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Ceredigion population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c5 <- ggplot(data = uk_counties, aes(x = NORFOLK, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Norfolk population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c6 <- ggplot(data = uk_counties, aes(x = WEST.LANCASHIRE, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "West Lancashire population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c7 <- ggplot(data = uk_counties, aes(x = NORTHUMBERLAND, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Northumberland population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


c8 <- ggplot(data = uk_counties, aes(x = ARGYLL, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Argyll population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 
  

c9 <- ggplot(data = uk_counties, aes(x = HIGHLAND, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Highland population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


multiplot(c1, c2, c3, c4, c5, c6, c7, c8, c9, cols = 3) 

```


Looking at rural areas e.g. Ireland, Northern Scotland and rural Wales 

Some of these areas have seeb a population decrease: counties picked ar random
```{r, include=FALSE}
library(Rmisc)

#Ireland, Scotland and Wales (more)

extra_counties <- read.csv("Ireland_Scot_Wales.csv")

d1 <- ggplot(data = extra_counties, aes(x = KERRY, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Kerry population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


d2 <- ggplot(data = extra_counties, aes(x = SLIGO, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Sligo population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


d3 <- ggplot(data = extra_counties, aes(x = INVERCLYDE, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Inverclyde population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 


d4 <- ggplot(data = extra_counties, aes(x = ANGELSEY, y = UK)) +
  geom_point(size = 0.5) +
  labs(x = "Angelsey population", y = "UK population") +
  geom_text(aes(label = YEAR), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

multiplot(d1, d2, d3, d4, cols = 2) 


```


###ii. Sampling bias - Basic plot (specific species/all species for that year)
Taking a look at individual species/total number of strandings per year 

Need to analyse the data 
```{r, include=FALSE}
#Using the cleaned dataset 
data <- read.csv("cleaned-data/cleandatesnames.csv") 

#Looking at species by year - a count of each species per year
speciesbyyear <- aggregate(n ~ Name.Current.Sci, speciesyearcount, sum)
View(speciesbyyear)
#Arranging species by year by count 
speciesbyyear <- speciesyearcount %>%
  group_by(n, Year, Name.Current.Sci) %>%
  arrange(Year)

#Total each of the years - this is using the totalcount dataset 
totalcount <- speciesyear %>% count("Year") 

ggplot(data = speciesyear, aes(x = Year)) +
         geom_histogram(binwidth = 0.5) +
  labs(x = "Year", y = "Total count") 


#Creating a data table of species, total per year and basic sampling effort 
library(dplyr)
yearoverview <- speciesyearcount %>% left_join(totalcount, by="Year") %>%
  arrange(Year) %>%
  mutate(sampling = n/freq)

library(readr)
library(ggplot2) 

#ugly graph of sampling effort for all species 
ggplot(data = yearoverview, aes(x = Year, y = sampling, color = Name.Current.Sci)) +
  geom_line() +
  xlim(1913, 2017) +
  theme_bw() +
  labs(title = "sampling effort")
```

```{r, include=FALSE}
sampling_list <- select(yearoverview, Name.Current.Sci, sampling) 
#Basic sampling effort for each species 
ggplot(yearoverview, aes(x = Year, y = sampling)) +
  geom_line() +
  xlim(1913, 2017) +
  theme_bw() + 
  labs(title = "Basic sampling effort for each species") +
  facet_wrap(~ Name.Current.Sci)
```


#Other plots include: 
- Bycatch heat maps 
- Focusing on data from CSIP only
- Military zone plots and beakers 
- Heatmap of shipstrike incidents and physical trauma

1. Excel spreadsheet: cross validation of data with OBIS:seamap data and JCP data for 'normal' cetacean ranges: Decision making on which species to include and which to omit
- "Strandings analysis"

#What I want to plot/look at: 
1. Statistical analysis of cross validation, population data (regression line), analysis of variance between datasets etc. 
2. Remove manky specimens and unknowns 
3. Observers per county - sampling effort 
4. SST - over the century - species abundance + GLM, all species and specifics 
5. Split up the data into sites e.g. 1-7 as in the literature and then create a rarecurve
6. Plot of interest - with WW1 and WWII etc marked: Need to find the code for this 

