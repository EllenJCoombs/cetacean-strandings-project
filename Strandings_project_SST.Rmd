---
title: "Strandings_Project_SST_Rmd"
author: "Ellen Coombs"
date: "07 August 2017"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I have selected 14 locations around the UK and Ireland. Locations were selected based on whether they were the most 'northerly', "easterly" etc for the country, or whether they offered a general geographical location e.g. for the NW and were at "grid point nearest to [chosen geographical location]"

The mean of all of these locations was taken. The following is code for extracting data for all 14 locations, as well as the mean UK SST (degrees celsius), for the time period 1912-2016. 

Data used in HadISST1 monthly sea surface temperature (1870 - present)
Files are netCDF (.nc format) and were read in using the ncdf package

A lot of the code was used to test the data were correct and is put in here as comments 

##Working with HadISST1 data 
###Pulling together the temperature data for Ireland and the UK
```{r setup, include=FALSE}

#Pulling together all of the data 

#Ireland data binding and cleaning 
Ireland <- bind_cols(Ireland_BrowHead, Ireland_Cleggan, Ireland_Wicklow)
  
Ireland <- Ireland %>%
    dplyr::rename(sst_Browhead_IR = sst) %>%
    dplyr::rename(sst_Cleggan_IR = sst1) %>%
    dplyr::rename(sst_Wicklow_IR = sst2) 

Ireland <- Ireland %>%
select(time, sst_Browhead_IR, sst_Cleggan_IR, sst_Wicklow_IR)
  

#UK data binding and cleaning 
UK <- bind_cols(UK_Ballyhillin, UK_Barrow, UK_Dover, UK_GoreCliff, UK_Holyhead, UK_JohnOGroats, 
                UK_LandsEnd, UK_Lindisfarne, UK_Lowerstoft, UK_Mull, UK_Shetland)

  
  UK <- UK %>%
    dplyr::rename(sst_Ballyhillin_UK = sst) %>%
    dplyr::rename(sst_Barrow_UK = sst1) %>%
    dplyr::rename(sst_Dover_UK = sst2) %>%
    dplyr::rename(sst_GoreCliff_UK = sst3) %>%
    dplyr::rename(sst_Holyhead_UK = sst4) %>%
    dplyr::rename(sst_JohnOGroats_UK = sst5) %>%
    dplyr::rename(sst_LandsEnd_UK = sst6) %>%
    dplyr::rename(sst_Lindisfarne_UK = sst7) %>%
    dplyr::rename(sst_Lowerstoft_UK = sst8) %>%
    dplyr::rename(sst_Mull_UK = sst9) %>%
    dplyr::rename(sst_Shetland_UK = sst10) 
  
  UK <- UK %>%
    select(time, sst_Ballyhillin_UK, sst_Barrow_UK, sst_Dover_UK, sst_GoreCliff_UK, sst_Holyhead_UK,
           sst_JohnOGroats_UK, sst_LandsEnd_UK, sst_Lindisfarne_UK, sst_Lowerstoft_UK, sst_Mull_UK, 
           sst_Shetland_UK)
  
#Binding the UK and Ireland 
UK_Ireland <- bind_cols(UK, Ireland)
#Removing the second time variable (from the Ireland datsset) as it is the same as the UK time 
#column and a duplicate is not needed 

UK_Ireland$time1 <- NULL

#write.csv(UK_Ireland, file = "UK_Ireland_SST.csv")
#Have added the mean

#UK_Ireland_SST <- read.csv("UK_Ireland_SST.csv")


#group = 1 tells R that the points should be connected for one group 
#group = g no lines drawn
#group = 2 lines are drawn for two seperate groups 

#This code plots Ireland 
ggplot() + 
  geom_line(data = Ireland_BrowHead, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = Ireland_Cleggan, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = Ireland_Wicklow, aes(x = time, y = sst, group = 1)) + 
  labs(y = "SST",
        x = "time") +
  ggtitle("Daily measured sea-surface-temperature, 1870 - 2017",   
          subtitle = "At model grid point nearest several Irish locations") + 
  theme_classic()
```

#Plots of the UK and Ireland
```{r setup, include=FALSE}
ggplot() + 
  geom_line(data = UK_Ballyhillin, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Barrow, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Dover, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_GoreCliff, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Holyhead, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_JohnOGroats, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_LandsEnd, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Lindisfarne, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Lowerstoft, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Mull, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = UK_Shetland, aes(x = time, y = sst, group = 1)) +
  geom_line(data = Ireland_BrowHead, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = Ireland_Cleggan, aes(x = time, y = sst, group = 1)) + 
  geom_line(data = Ireland_Wicklow, aes(x = time, y = sst, group = 1)) + 
  geom_smooth(span = 0.3) +
  labs(y = "SST",
       x = "time") +
  ggtitle("Daily measured sea-surface-temperature, 1870 - 2017",   
          subtitle = "At model grid points nearest to several UK and Irish locations") + 
  theme_classic() 
```

```{r setup, include=FALSE}
###Want to plot the mean SST

UK_mean_SST <- UK_Ireland_SST %>%
  select(Date, UK_mean) 

#Plotting UK mean temperature 
ggplot() + 
  geom_line(data = UK_mean_SST, aes(x = Date, y = UK_mean, group = 1)) + 
  scale_colour_gradient(low='yellow', high='#de2d26') +
  labs(y = "SST",
       x = "time") +
  ggtitle("Daily measured sea-surface-temperature, 1870 - 2017",   
          subtitle = "UK mean") + 
  theme_classic()


```


##Extracting yearly max SST from the 14 UK and Ireland sites 
```{r setup, include=FALSE}
#Extracting yearly max SST data 

#Splitting SST into day, month, year 
df <- data.frame(date = UK_mean_SST$Date,
                 year = as.numeric(format(UK_mean_SST$Date, format = "%Y")),
                 month = as.numeric(format(UK_mean_SST$Date, format = "%m")),
                 day = as.numeric(format(UK_mean_SST$Date, format = "%d")))

#Binding SST and dates/months/years and removing the extra 'date' 
SST_day_month_year <- bind_cols(df, UK_mean_SST) 
SST_day_month_year$Date <- NULL

#Average SST for each of the months from 1912 - 2016
aggregate(SST_day_month_year$UK_mean, by = list(SST_day_month_year$year), max)
SST_yearly_max <- aggregate(UK_mean ~ year, data = SST_day_month_year, max)

#Renaming the max_year temp and also selcting from 1913:2015 only (as my data starts
#1912 and ends halfway through 2016)
SST_yearly_max <- SST_yearly_max %>%
  dplyr::rename(year_max = UK_mean) %>%
  filter(year %in% c(1913:2015))

ggplot(data = SST_yearly_max, aes(x = year, y = year_max)) +
  geom_line() + 
  xlab("Year") + ylab("Maximum recorded SST ("~degree~"C)") + 
  ggtitle("Yearly maximum UK sea-surface-temperature (SST) (1913 - 2015)",
          subtitle = "Average taken from 14 sites closest to chosen model grid points") + 
  theme_classic()


##############################################################################################
#Extracting monthly maximum.... 
#Need to go back to the original dataset as the above uses the mean 

#CAN'T GET THIS TO WORK 
#UK_Ireland_SST <- UK_Ireland_SST %>%
  #dplyr::rename(Date = time)

#UK_Ireland_SST <- mutate(UK_Ireland_SST, Date = ymd(Date))

#ef <- data.frame(date = UK_Ireland_SST$Date,
                 #year = as.numeric(format(UK_Ireland_SST$Date, format = "%Y")),
                 #month = as.numeric(format(UK_Ireland_SST$Date, format = "%m")),
                 #day = as.numeric(format(UK_Ireland_SST$Date, format = "%d")))


#max(UK_Ireland_SST_dates[1,5:19])
#UK_Ireland_SST$max <- apply(UK_Ireland_SST[,5:19], max)
#head(UK_Ireland_SST, 10)


UK_Ireland_SST_max <- read.csv("UK_Ireland_SST.csv")

```

#Looking at strandings and SST 

```{r setup, include=FALSE}
#Splitting species data into monthly/quarterly time slots 

#Using the cleaneddata dataset 
library(dplyr)
library(ggplot2)
library(lubridate)


cleaneddata <- read.csv("cleandatesnames.csv")
sapply(cleaneddata, class)

#Having problems with the data format - need dates to be 'date' class
cleaneddata <- mutate(cleaneddata, Date = dmy(Date))
#Trying this instead - works by changing all 2000s to 1900s
#cleaneddata <- mutate(cleaneddata, Date = format(as.Date(Date, "%d-%b-%y"), "19%y-%m-%d"))

#write.csv(cleaneddata, file = "cleandatesnames.csv")

#Now Date should be 'Date' class 

#Selecting the chosen area (if required)
M_novaengliae <- cleaneddata %>% 
  filter(Name.Current.Sci == "Megaptera novaeangliae") 

#Use a variation of the following code if you want to select a specfic window 
#nw_window <- nw_scotland_strandings %>% 
  #filter(Year %in% c(1989:2000))

#Shows this datset by year but I need it by month.....
#ggplot(nw_window, aes(x = Date)) + 
  #stat_count(width = 0.5) 

mn_window <- M_novaengliae %>%
  filter(Year %in% c(1913:2015))

library(zoo)
library(dplyr)

#Splitting my data into strandings per month 
mn_window$monthYear <- as.Date(as.yearmon(mn_window$Date))
mn_window$quarterYear <- as.Date(as.yearqtr(mn_window$Date))
head(mn_window)
#Strandings gathered into months 
mn_monthly <- head(mn_window %>% group_by(monthYear) %>% dplyr::summarise(n = n()), 21)
#Strandings per quarter 
mn_quarter <- head(mn_window %>% group_by(quarterYear) %>% dplyr::summarise(n = n()), 20)

#Grouping by week number - not really needed - not running properly
#pp_window$week <- as.Date("1913-01-01")+7*trunc((pp_window$joinTimestamp / 1000)/(3600*24*7))

#Line plot of strandings per month (grouped)
#Have changed monthYear to Date 
ggplot(data = la_monthly, aes(x = monthYear, y = n, group=1)) +
  geom_line()

ggplot(ba_monthly, aes(n)) +
  geom_histogram(binwidth = 0.5)
  
```

###Plotting mean monthly temperatures 
```{r setup, include=FALSE}

#Plotting species against temperature 
#Example here is Phocoena monthly strandings against STT monthly temps (UK averaged 
#from 14 locations)

#Monthly stranding data is from the above code 
#SST is from the HadISST_Uk.R code 

UK_Ireland_SST <- read.csv("UK_Ireland_SST.csv")

#Renaming time to Date 
UK_Ireland_SST <- UK_Ireland_SST %>%
  dplyr::rename(Date = time)

#Selecting only the UK_mean 
UK_mean_SST <- UK_Ireland_SST %>%
  select(Date, UK_mean) 

#Selecting only 1913:2015
#Need to make Data a date first 
UK_mean_SST <- mutate(UK_mean_SST, Date = ymd(Date))
sapply(UK_mean_SST, class)

write.csv(UK_mean_SST, file = "UK_mean_SST.csv")

#Filtering out specific dates 
UK_mean_SST <- UK_mean_SST %>%
  filter(Date >= "1912-12-16", Date <= "2016-01-16")


#Plotting UK mean temperature 
#Need to play with the months!
bb1 <- ggplot() + 
  geom_line(data = UK_mean_SST, aes(x = Date, y = UK_mean, group = 1)) + 
  #geom_smooth(se = FALSE) +
  #scale_colour_gradient(low='yellow', high='#de2d26') +
  labs(y = "SST",
       x = "time") +
  ylim(5,17) +
  ggtitle("Monthly mean sea-surface-temperature (1870 - 2017)",   
          subtitle = "UK monthly mean") + 
  theme_classic()

bb1




```


This code splits strandings monthly so that they can be plotted against monthly SST
```{r setup, include=FALSE}
#Splitting species data into monthly/quarterly time slots 

#Using the cleaneddata dataset 
library(dplyr)
library(ggplot2)
library(lubridate)


cleaneddata <- read.csv("cleandatesnames.csv")
sapply(cleaneddata, class)

#Having problems with the data format - need dates to be 'date' class
cleaneddata <- mutate(cleaneddata, Date = dmy(Date))
#Trying this instead - works by changing all 2000s to 1900s
#cleaneddata <- mutate(cleaneddata, Date = format(as.Date(Date, "%d-%b-%y"), "19%y-%m-%d"))

#write.csv(cleaneddata, file = "cleandatesnames.csv")

#Now Date should be 'Date' class 

#Selecting the chosen area (if required)
P_phocoena <- cleaneddata %>% 
  filter(Name.Current.Sci == "Phocoena phocoena") 

sapply(P_phocoena, class)
#Use a variation of the following code if you want to select a specfic window 
#nw_window <- nw_scotland_strandings %>% 
  #filter(Year %in% c(1989:2000))

#Shows this datset by year but I need it by month.....
#ggplot(nw_window, aes(x = Date)) + 
  #stat_count(width = 0.5) 

pp_window <- P_phocoena %>%
  filter(Year %in% c(1913:2015))

library(zoo)
library(dplyr)

#Splitting my data into strandings per month 
pp_window$monthYear <- as.Date(as.yearmon(pp_window$Date))
pp_window$quarterYear <- as.Date(as.yearqtr(pp_window$Date))
head(pp_window)
#Strandings gathered into months 
pp_monthly <- head(pp_window %>% group_by(monthYear) %>% dplyr::summarise(n = n()), 7667)
#Strandings per quarter 
pp_quarter <- head(pp_window %>% group_by(quarterYear) %>% dplyr::summarise(n = n()), 818)

#Grouping by week number - not really needed - not running properly
#pp_window$week <- as.Date("1913-01-01")+7*trunc((pp_window$joinTimestamp / 1000)/(3600*24*7))

#Line plot of strandings per month (grouped)
#Have changed monthYear to Date 
ggplot(data = pp_monthly, aes(x = monthYear, y = n, group=1)) +
  geom_line()

ggplot(ba_monthly, aes(n)) +
  geom_histogram(binwidth = 0.5)

```


```{r setup, include=FALSE}

##########################################################################################
#Plotting species against temperature 
#Example here is Phocoena monthly strandings against STT monthly temps (UK averaged 
#from 14 locations)

#Monthly stranding data is from the above code 
#SST is from the HadISST_Uk.R code 

UK_Ireland_SST <- read.csv("UK_Ireland_SST.csv")

#Renaming time to Date 
UK_Ireland_SST <- UK_Ireland_SST %>%
  dplyr::rename(Date = time)

#Selecting only the UK_mean 
UK_mean_SST <- UK_Ireland_SST %>%
  select(Date, UK_mean) 

#Selecting only 1913:2015
#Need to make Data a date first 
UK_mean_SST <- mutate(UK_mean_SST, Date = ymd(Date))
sapply(UK_mean_SST, class)

write.csv(UK_mean_SST, file = "UK_mean_SST.csv")

#Filtering out specific dates 
UK_mean_SST <- UK_mean_SST %>%
  filter(Date >= "1912-12-16", Date <= "2016-01-16")


#Plotting UK mean temperature 
#Need to play with the months!
bb1 <- ggplot() + 
  geom_line(data = UK_mean_SST, aes(x = Date, y = UK_mean, group = 1)) + 
  #geom_smooth(se = FALSE) +
  #scale_colour_gradient(low='yellow', high='#de2d26') +
  labs(y = "SST",
       x = "time") +
  ylim(5,17) +
  ggtitle("Monthly mean sea-surface-temperature, 1870 - 2017",   
          subtitle = "UK mean") + 
  theme_classic()

bb1


```


Taking a quick look at monthly strandings and monthly mean SST
```{r setup, include=FALSE}

#Plotting strandings against temp 


#Changing "monthYear" to "Date" in species data 
ba_monthly <- ba_monthly %>%
  dplyr::rename(Date = monthYear)
  
  
#PPhocoena monthly strandings and monthly SST
  ggplot() + 
    geom_line(data = UK_mean_SST, aes(x = Date, y = UK_mean)) + 
    geom_line(data = strandings_monthly, aes(x = Date, y = n/10)) +
    scale_y_continuous(sec.axis = sec_axis(~.*10, name = "Monthly strandings")) +
    labs(y = "SST ("~degree~"C)",
         x = "Year")

```


```{r setup, include=FALSE}

library(zoo)
#Making the date for temperature the first of the month (for that whole month) 
UK_mean_01_month <- UK_mean_SST

#Make the SST yearly 
UK_mean_01_month$monthYear <- as.Date(as.yearmon(UK_mean_01_month$Date))
UK_mean_01_month$quarterYear <- as.Date(as.yearqtr(UK_mean_01_month$Date))
#head(UK_mean_01_month)

#Line plot of strandings per month (grouped)
#Have changed monthYear to Date 
ggplot(data = UK_mean_01_month, aes(x = monthYear, y = UK_mean, group=1)) +
  geom_line()
```


Plotting UK mean SST against a specific species (or all species)
```{r setup, include=FALSE}
combined <- UK_mean_01_month %>% 
  select(UK_mean, monthYear) %>%
  dplyr::rename(Date = monthYear)
  
#Combining uk_mean temp with species data 
combined <- merge(combined, species_monthly, all = TRUE, by = c('Date'))
#Replacing NA with 0 
combined <- combined %>%
  mutate(n = ifelse(is.na(n),0, n))

#Phocoena strandings (monthly) vs monthly SST
ggplot(data = combined, aes(x = UK_mean, y = n)) +
  geom_point(size = 0.5) +
  labs(x = "Sea Surface Temperature ("~degree~"C)", y = "Monthly strandings") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

```

```{r setup, include=FALSE}
#Yearly max temp against yearly strandings 
#This is total_count 

#Bind STT_yearly max and totalcount 
SST_total_strandings <- bind_cols(SST_yearly_max, totalcount)
#remove duplicate 'Year' 
SST_total_strandings$Year <- NULL
#rename freq to strandings 
SST_total_strandings <- SST_total_strandings %>%
  dplyr::rename(strandings = n)

#write.csv(SST_total_strandings, file = "SST_strandings_UK.csv")

#Yearly strandings total and yearly max temps 
f1 <- ggplot(data = SST_total_strandings, aes(x = year_max, y = strandings)) +
  geom_point(size = 0.5) +
  geom_text(aes(label = year), size = 3, vjust = -0.5) +
  labs(x = "Yearly max. sea surface temperature ("~degree~"C)", y = "Yearly total strandings") +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

f1

#Data analysis 
modelSST <- lm(log(strandings) ~ log(year_max), data = SST_total_strandings)
summary(modelSST)

```

Total species per year and yearly max SST 
```{r setup, include=FALSE}
#Total number of species per year, and maximum temp 
#Using total_speciesbyyear 

#Binding total strandings, total species per year and max years SST 
SST_total_strandings <- bind_cols(total_speciesbyyear, SST_total_strandings)
#Renaming strandings to strandings_total
SST_total_strandings <- SST_total_strandings %>%
  dplyr::rename(strandings_total = strandings)

#Selecting the specific columns
SST_total_strandings <- SST_total_strandings %>%
  select(Year, year_max, species, strandings_total)

#Plotting yearly total species number against max yearly SST
ggplot(data = SST_total_strandings, aes(x = year_max, y = species)) +
  geom_point(size = 0.5) +
  geom_text(aes(label = Year), size = 3, vjust = -0.5) +
  labs(x = "Yearly max. sea surface temperature ("~degree~"C)", y = "Total species recorded") +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

#Data analysis - total species and yearly max SST
modelSST <- lm(log(species) ~ log(year_max), data = SST_total_strandings)
summary(modelSST)
```

Monthly strandings
```{r setup, include=FALSE}
#Monthly species strandings (only have yearly at the moment)
library(dplyr)
library(plyr)
library(lubridate)
library(zoo)
library(ggplot2)

cleaneddata <- read.csv("cleaned-data/cleandatesnames.csv")
#I want all species 

strandings_window <- cleaneddata %>%
  filter(Year %in% c(1913:2015))

sapply(strandings_window, class)
#Be cautious of the format: dmy, ymd
strandings_window <- mutate(strandings_window, Date = dmy(Date))

sapply(strandings_window, class)

#Splitting my data into strandings per month 
strandings_window$monthYear <- as.Date(as.yearmon(strandings_window$Date))
strandings_window$quarterYear <- as.Date(as.yearqtr(strandings_window$Date))
head(strandings_window)

#Strandings gathered into months 
strandings_monthly <- head(strandings_window %>% group_by(monthYear) %>% dplyr::summarise(n = n()), 17402)
#Strandings per quarter 
strandings_quarter <- head(strandings_window %>% group_by(quarterYear) %>% dplyr::summarise(n = n()), 1133)

#Grouping by week number - not really needed - not running properly
#pp_window$week <- as.Date("1913-01-01")+7*trunc((pp_window$joinTimestamp / 1000)/(3600*24*7))

#Line plot of strandings per month (grouped)
#Have changed monthYear to Date 
strandings_monthly <- strandings_monthly %>%
  dplyr::rename(Date = monthYear)

#Monthly strandings 
ggplot(data = strandings_monthly, aes(x = Date, y = log(n), group=1)) +
  geom_line() +
  labs(y = "Monthly strandings") 

ggplot(strandings_monthly, aes(n)) +
  geom_histogram(binwidth = 0.5)

```


After 1970 but can play with any dates 
```{r setup, include=FALSE}
#Can play around with the dates 
strandings_monthly_1970 <- strandings_monthly %>%
  filter(Date >= "1970-01-01", Date <= "2016-01-01")
#Plot
ggplot(data = strandings_monthly_1970, aes(x = Date, y = log(n), group=1)) +
  geom_line() +
  labs(y = "Monthly strandings since 1970") 

#Quarterley strandings - split into Jan, April, July and October 
#Firstly making date 'Date' 
strandings_quarter <- strandings_quarter %>%
  dplyr::rename(Date = quarterYear)

ggplot(data = strandings_quarter, aes(x = Date, y = log(n), group=1)) +
  geom_line() +
  labs(y = "Quarterly strandings")

#After 1970 only
#Can play around with the dates 
strandings_quarter_1970 <- strandings_quarter %>%
  filter(Date >= "1970-01-01", Date <= "2016-01-01")

#Plot
ggplot(data = strandings_quarter_1970, aes(x = Date, y = log(n), group=1)) +
  geom_line() +
  labs(y = "Quarterly strandings since 1970") 
```

Monthly mean SST against monthly strandings 
```{r setup, include=FALSE}
#Monthly mean SST against monthly strandings 
ggplot() +
  geom_line(data = strandings_monthly, aes(x = Date, y = n/5)) +
  geom_line(data = UK_mean_SST, aes(x = Date, y = UK_mean)) +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Monthly stranded species")) +
  labs(x = "Date", y = "Monthly mean SST ("~degree~"C)")
```
 
 
###Playing around with monthly MAX SST
```{r setup, include=FALSE}
#UK monthly max 
#Change time to date 

UK_Ireland_SST_max <- read.csv("cleaned-data/UK_Ireland_SST.csv")
UK_Ireland_SST_max <- UK_Ireland_SST_max %>%
  dplyr::rename(Date = time)

#Specific columns 
UK_monthly_SST <- UK_Ireland_SST_max %>%
  select(Date, Monthly_max)

sapply(UK_monthly_SST, class)


#Filter out the dates 
UK_monthly_SST <- mutate(UK_monthly_SST, Date = ymd(Date))
  UK_monthly_SST <- UK_monthly_SST %>%
           filter(Date >= "1912-12-16", Date <= "2016-01-16")

  
#Monthly max temp and monthly strandings 
ggplot() +
  geom_line(data = strandings_monthly, aes(x = Date, y = n/10)) +
  geom_line(data = UK_monthly_SST, aes(x = Date, y = Monthly_max)) +
  scale_y_continuous(sec.axis = sec_axis(~.*10, name = "Monthly strandings")) +
  labs(x = "Date", y = "Monthly maximum SST ("~degree~"C)")
 
```


###Monthly max SST and monthly strandings 
```{r setup, include=FALSE}
#binding monthly max temp and monthly strandings 
#Not happy with this as this is only one temp from one location which happens to have the highest 
#value :( 
#Also changing dates to 01 of the month 

#Making the date for temperature the first of the month (for that whole month) 
UK_01_month_max <- UK_monthly_SST

UK_01_month_max$monthYear <- as.Date(as.yearmon(UK_01_month_max$Date))
UK_01_month_max$quarterYear <- as.Date(as.yearqtr(UK_01_month_max$Date))
head(UK_01_month_max)

#Selecting specific rows 
UK_01_month_max <- UK_01_month_max %>% 
  select(Monthly_max, monthYear) %>%
  dplyr::rename(Date = monthYear)

#Merging the two datasets 
monthly_max_strandings <- merge(UK_01_month_max, strandings_monthly, all = TRUE, by = c('Date'))
#Replacing NA with 0 
monthly_max_strandings <- monthly_max_strandings %>%
  mutate(n = ifelse(is.na(n),0, n))

monthly_max_strandings <- monthly_max_strandings %>%
  dplyr::rename(strandings = n)

#Plot of monthly max temp from one single point - yuck and all monthly strandings 
ggplot(data = monthly_max_strandings, aes(x = Monthly_max, y = strandings)) +
  geom_point(size = 0.5) +
  labs(x = "Monthly max sea surface temperature ("~degree~"C)", y = "Monthly strandings") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

#This doesn't work because of the NAs in my dataset, I think 
model_all_species <- lm(log(strandings) ~ log(Monthly_max), data = monthly_max_strandings)
summary(modelSST)

```


As before, but removing Phocoena phocoena 
```{r setup, include=FALSE}
#As above but removing Phocoena phocoena  
#Using UK_01_month_max

#Need to remove Phocoena Phocoena from the original dataset 

cleaneddata <- read.csv("cleaned-data/cleandatesnames.csv")
#I want all species 

strandings_window_no_phocoena <- cleaneddata %>%
  filter(Year %in% c(1913:2015)) %>%
  filter(!Name.Current.Sci %in% c("Phocoena phocoena"))

sapply(strandings_window_no_phocoena, class)
#Changing date to "Date". Be cautious of the format: dmy, ymd
strandings_window_no_phocoena <- mutate(strandings_window_no_phocoena, Date = dmy(Date))

#Splitting my data into strandings per month 
strandings_window_no_phocoena$monthYear <- as.Date(as.yearmon(strandings_window_no_phocoena$Date))
strandings_window_no_phocoena$quarterYear <- as.Date(as.yearqtr(strandings_window_no_phocoena$Date))
head(strandings_window_no_phocoena)

#Strandings gathered into months 
strandings_monthly_no_phocoena <- head(strandings_window_no_phocoena %>% group_by(monthYear) %>% dplyr::summarise(n = n()), 9735)
#Strandings per quarter 
strandings_quarter_no_phocoena <- head(strandings_window_no_phocoena %>% group_by(quarterYear) %>% dplyr::summarise(n = n()), 1057)

#Grouping by week number - not really needed - not running properly
#pp_window$week <- as.Date("1913-01-01")+7*trunc((pp_window$joinTimestamp / 1000)/(3600*24*7))

#Line plot of strandings per month (grouped)
#Have changed monthYear to Date 
strandings_monthly_no_phocoena <- strandings_monthly_no_phocoena %>%
  dplyr::rename(Date = monthYear)

#Monthly strandings 
ggplot(data = strandings_monthly_no_phocoena, aes(x = Date, y = log(n), group=1)) +
  geom_line() +
  labs(y = "Monthly strandings of Phocoena phocoena")

#Plotting monthly strandings of Phocoena phocoena against monthly max temperatures 

monthly_max_strandings_no_phocoena <- merge(UK_01_month_max, strandings_monthly_no_phocoena, all = TRUE, by = c('Date'))
#Replacing NA with 0 
monthly_max_strandings_no_phocoena <- monthly_max_strandings_no_phocoena %>%
  mutate(n = ifelse(is.na(n),0, n))

#Renaming "n" strandings
monthly_max_strandings_no_phocoena <- monthly_max_strandings_no_phocoena %>%
  dplyr::rename(strandings = n)

#Plot of monthly max temp from one single point - yuck and all monthly strandings 
ggplot(data = monthly_max_strandings_no_phocoena, aes(x = Monthly_max, y = strandings)) +
  geom_point(size = 0.5) +
  labs(x = "Monthly max sea surface temperature ("~degree~"C)", y = "Monthly strandings (Phocoena phocoena removed)") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 
```


##Plotting all species and then Phocoena seperately
```{r setup, include=FALSE}
#Plotting all species and then Phocoena seperately 
pp_monthly <- pp_monthly %>%
  dplyr::rename(Date = monthYear)

monthly_max_phocoena <- merge(UK_01_month_max, pp_monthly, all = TRUE, by = c('Date'))
#Replacing NA with 0 
monthly_max_phocoena <- monthly_max_phocoena %>%
  mutate(n = ifelse(is.na(n),0, n))

#Renaming "n" strandings
monthly_max_phocoena <- monthly_max_phocoena %>%
  dplyr::rename(strandings = n)

#Plot of monthly max temp from one single point - yuck and all monthly strandings 
ggplot(data = monthly_max_strandings_no_phocoena, aes(x = Monthly_max, y = strandings)) +
  geom_point(data = monthly_max_phocoena, aes(x = Monthly_max, y = strandings, color = "red")) +
  geom_point(size = 0.5) +
  labs(x = "Monthly max sea surface temperature ("~degree~"C)", y = "Monthly strandings", 
       colour = "Phocoena phocoena") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 
```


##Monthly max temp from one location against monthly strandings 
```{r setup, include=FALSE}
#All strandings - monthly max SST 
#Merging the two datasets 
monthly_max_strandings <- merge(UK_01_month_max, strandings_monthly, all = TRUE, by = c('Date'))
#Replacing NA with 0 
monthly_max_strandings <- monthly_max_strandings %>%
  mutate(n = ifelse(is.na(n),0, n))

monthly_max_strandings <- monthly_max_strandings %>%
  dplyr::rename(strandings = n)

#Plot of monthly max temp from one single point - yuck and all monthly strandings 
ggplot(data = monthly_max_strandings, aes(x = Monthly_max, y = strandings)) +
  geom_point(size = 0.5) +
  labs(x = "Monthly max sea surface temperature ("~degree~"(C))", y = "Monthly strandings") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 

#This doesn't work because of the NAs in my dataset, I think 
model_all_species <- lm(log(strandings) ~ log(Monthly_max), data = monthly_max_species)
summary(modelSST)
```


Plotting specific species against monthly max SST 
```{r setup, include=FALSE}
#Plotting specific species against monthly max SST 
#Merging the two datasets 
#Have to get Date into species data too 

mn_monthly <- mn_monthly %>%
  dplyr::rename(Date = monthYear)

monthly_m_novaengliae <- merge(UK_01_month_max, mn_monthly, all = TRUE, by = c('Date'))
#Replacing NA with 0 
monthly_m_novaengliae <- monthly_m_novaengliae %>%
  mutate(n = ifelse(is.na(n),0, n))

#Plot species and max monthly temp 
ggplot(data = monthly_m_novaengliae, aes(x = Monthly_max, y = n)) +
  geom_point(size = 0.5) +
  labs(x = "Monthly max sea surface temperature ("~degree~"C)", y = "Monthly Megaptera novaeangliae strandings") +
  #geom_text(aes(label = Date), size = 3, vjust = -0.5) +
  geom_smooth(method = lm, se=FALSE, colour = "grey70", size =0.7) 
```
